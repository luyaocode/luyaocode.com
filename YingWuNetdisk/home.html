<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="../img/yingwu.ico" type="image/x-icon" />
    <title>鹦鹉网盘</title>
    <link rel="stylesheet" href="../css/bootstrap.min.css">
    <link href="../css/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="../css/all.min.css">
    <link rel="stylesheet" href="../css/common.css">
    <style>
        body {
            transition: background-color 0.3s, color 0.3s;
        }

        .btn {
            white-space: nowrap;
            /* 防止文本换行 */
        }

        .modal {
            max-height: 80vh;
        }

        .page-item {
            padding: 2px;
        }

        .page-link {
            padding: 5px 10px;
            font-size: 12px;
        }

        .navbar {
            margin: 0;
        }

        .navbar-brand {
            font-size: 16px;
            font-weight: bold;
            margin-left: 0;
            color: #007bff;
            transition: color 0.3s;
        }

        .navbar-brand:hover {
            color: #0056b3;
            text-decoration: underline;
        }

        small {
            white-space: nowrap;
        }

        .container {
            /* 内容上边距统一为60px */
            margin-top: 60px;
            max-width: 98%;
        }

        #dropZone {
            border: 2px dashed #007bff;
            border-radius: 5px;
            padding: 40px 10px;
            text-align: center;
            /* margin-bottom: 10px; */
            position: relative;
            transition: background-color 0.3s;
            background-color: #e9f7ff;
        }

        #dropZone.dragover {
            background-color: #b3e0ff;
        }

        #uploadButton {
            font-size: 30px;
            background: transparent;
            border: none;
            color: #007bff;
            cursor: text;
        }

        .file-list {
            max-height: 500px;
            overflow-y: auto;
            /* margin-bottom: 10px; */
            background-color: #ffffff;
            border-radius: 5px;
            padding: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .file-list ul {
            padding-left: 0;
        }

        .file-list li {
            list-style-type: none;
            border-bottom: 1px solid #f1f1f1;
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background-color 0.2s;
        }

        .file-list li:hover {
            background-color: #f1f1f1;
        }

        .remove-file {
            cursor: pointer;
            color: red;
            margin-left: 10px;
            font-weight: bold;
        }

        .row {
            display: flex;
            justify-content: space-between;
        }

        .col {
            flex: 1;
            margin: 0 10px;
        }

        .upload-area {
            background-color: #f3f5f6;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            border: 1px solid white;
        }

        .download-area {
            background-color: #f4f4f4;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            border: 1px solid white;
        }

        .lock-status,
        .expired-time {
            font-size: 12px;
            white-space: nowrap;
            padding: 1px;
        }

        /* 上传加载框 */
        #waitingModal {
            display: none;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background-color: rgba(0, 0, 0, 0.5);
            max-height: 100%;
        }

        #loading-content {
            background-color: transparent;
            border: none;
            margin-top: 40vh;
        }

        .loading-spinner {
            color: white;
        }

        /* 预览容器 */
        .preview-container {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            /* 确保容器位于蒙版之上 */
            background: rgba(0, 0, 0, 0.6);
            /* 半透明背景蒙版 */
        }

        /* 内容容器居中 */
        .preview-content {
            width: 90%;
            max-width: 1000px;
            max-height: 96vh;
            background-color: #fff;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            /* 添加阴影 */
            border-radius: 8px;
            padding: 20px;
            box-sizing: border-box;
            overflow: auto;
            display: flex;
            flex-direction: column;
        }

        /* 内嵌的图片和 PDF 内容容器 */
        .preview-content img {
            width: auto;
            max-height: 60vh;
            object-fit: contain;
        }

        /* PDF 内容居中 */
        .preview-content canvas {
            display: block;
            max-width: 100%;
            margin: 0 auto;
        }

        #pdf-content {
            display: none;
            flex-direction: column;
        }

        #text-content,
        #image-content {
            display: none;
            flex-direction: column;
            max-height: 80vh;
        }

        .image-preview {
            max-height: 10%;
        }

        .hidden {
            display: none;
        }

        .modal-dialog {
            max-width: 80%;
            margin-left: 10%;
        }

        .confirm-delete-modal {
            max-width: 60%;
            margin-left: 20%;
            margin-top: 10%;
        }

        .modal-body {
            overflow: auto;
        }

        .modal-content {
            word-break: break-all;
        }

        /* 表格样式 */
        .table {
            width: 100%;
            table-layout: auto;
            margin-bottom: 0;
        }

        .table td,
        .table th {
            vertical-align: middle;
            max-width: 100%;
            padding: 0.1rem 0.1rem;
        }

        .table td a {
            text-decoration: none;
        }

        /* 无文本加载弹窗 */
        #loadingModal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            text-align: center;
            line-height: 100vh;
            font-size: 1.5rem;
            z-index: 9999;
            user-select: none;
        }

        .waiting-spinner {
            margin-bottom: 20px;
        }

        /* 记录表 */
        /* 浅蓝色标识 */
        .label-style {
            color: #5bc0de;
            /* 浅蓝色 */
            font-weight: bold;
            /* 可选，突出显示 */
        }

        /* 浅蓝色 URL */
        .url-style {
            color: #5bc0de;
            /* 浅蓝色 */
            text-decoration: none;
            /* 去掉下划线 */
        }

        .url-style:hover {
            text-decoration: underline;
            /* 鼠标悬停时显示下划线 */
        }

        /* closePreview-pdf btn */

        #pdf-content {
            display: none;
            flex-direction: column;
            background-color: white;
            width: 100%;
            height: 100vh;
            /* 使用全屏高度 */
            overflow: auto;
            position: relative;
            justify-content: space-between;
        }

        #pdf-container {
            display: flex;
            flex-direction: row;
            overflow: auto;
            width: 100%;
        }

        /* pdf操作栏 */
        #pdf-toolbar-top {
            position: sticky;
            top: 0;
            z-index: 1000;
            background-color: #f7f7f7;
        }

        #pdf-toolbar {
            position: sticky;
            /* margin-top: 40px; */
            bottom: 0;
            z-index: 1000;
            background-color: #f7f7f7;
        }

        #outline-container {
            background-color: #f4f4f4;
            overflow-y: scroll;
            padding: 20px;
            border-right: 1px solid #ccc;
            width: 30%;
            max-width: 400px;
            position: relative;
            height: 100%;
            display: none;
            flex-direction: column;
        }

        #canvas_toolbar_container {
            width: 70%;
            flex-grow: 1;
            overflow: auto;
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: start;
        }

        #pdf-canvas-container {
            width: 100%;
            flex-grow: 1;
            overflow: auto;
        }

        #pdf-canvas {
            flex-grow: 1;
            cursor: grab;
        }

        #pdf-canvas:active {
            cursor: grabbing;
        }

        .outline-item {
            margin-bottom: 10px;
            cursor: pointer;
            font-size: 12PX;
            display: flex;
            flex-direction: row;
            justify-content: space-between;
            /* 左右分布 */
            align-items: center;
            /* 垂直居中 */
            border-bottom: 1px solid #ddd;
            /* 添加分隔线 */
        }

        .outline-item:hover {
            color: #007BFF;
        }

        /* 标题样式 */
        .outline-title {
            flex-grow: 1;
            /* 占用剩余空间 */
            font-size: 14px;
            overflow: hidden;
            /* 溢出隐藏 */
            text-overflow: ellipsis;
            /* 溢出显示省略号 */
            white-space: nowrap;
            /* 禁止换行 */
        }

        /* 页码样式 */
        .outline-page-number {
            flex-shrink: 0;
            /* 防止被压缩 */
            width: 50px;
            /* 固定宽度 */
            text-align: right;
            /* 文本右对齐 */
            font-size: 14px;
            color: #888;
            /* 浅色 */
        }

        .nested {
            margin-left: 20px;
        }

        #note-iframe {
            display: none;
            width: 100%;
            height: 600;
            border: none;
        }

        #toolbar-top-container,
        #toggle-note-btn-container,
        #toggle-outline-btn-container {
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        /* 开关笔记按钮 */
        .btn-toggle-note {
            position: absolute;
            top: 50%;
            right: 100%;
            transform: translateY(-100%);
            background-color: rgba(129, 129, 129, 0.2);
            border: none;
            padding: 10px 4px;
            cursor: pointer;
            font-size: 16px;
            color: #b6b6b6;
            border-radius: 3px;
            z-index: 1000;
        }

        #btnTogglePdfNote {
            display: none;
        }

        @media (min-width: 768px) {
            #btnTogglePdfNote {
                display: block;
            }
        }

        .tool-btn {
            position: absolute;
            top: 50%;
            left: 0;
            transform: translateY(-100%);
            background-color: rgba(129, 129, 129, 0.2);
            border: none;
            padding: 10px 4px;
            cursor: pointer;
            font-size: 16px;
            color: #b6b6b6;
            border-radius: 3px;
            z-index: 1000;
        }

        #tool-sidebar {
            display: flex;
            flex-direction: row;
            position: absolute;
            top: 0;
            left: 0;
            border: none;
            z-index: 1000;
        }

        #tool-sidebar button {
            border: none;
            color: #b6b6b6;
            cursor: pointer;
            font-size: 20px;
            border-radius: 3px;
            margin-right: 10px;
            background-color: rgba(129, 129, 129, 0.2);
        }

        #resizer {
            position: absolute;
            top: 0;
            right: 0;
            width: 5px;
            /* 调节条宽度 */
            height: 100%;
            cursor: ew-resize;
            /* 鼠标悬浮时显示左右拖动图标 */
            background-color: transparent;
            /* 初始透明 */
        }

        #resizer:hover {
            background-color: rgba(0, 0, 0, 0.1);
            /* 悬浮时的视觉效果 */
        }

        .btn-toggle-note i,
        .tool-btn i {
            transition: transform 0.3s ease;
        }

        .btn-toggle-note.expand i,
        .tool-btn.expand i {
            transform: rotate(180deg);
        }

        /* 在目录折叠时隐藏内容 */
        .expand #outline-list {
            display: none;
        }

        /*  */
        #cache-list {
            margin-bottom: 20px;
        }

        /* 优化菜单项的布局 */
        .dropdown-item {
            font-size: 0.85rem;
            padding: 0.5rem 1rem;
            cursor: pointer;
        }

        /* 可选：禁用项的样式 */
        .dropdown-item.disabled {
            cursor: default;
            font-weight: normal;
        }

        /* 图标和文字间距调整 */
        .dropdown-item i {
            font-size: 1rem;
            margin-right: 0.5rem;
        }

        /* 列表 */
        .file-name {
            display: -webkit-box;
            line-clamp: 3;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
            word-break: break-all;
            min-width: 200px;
        }

        /* 进度条 */
        .progress {
            min-width: 60px;
        }
    </style>
    <script src="../js/cookieConsent.js"></script>
</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
        <div class="container-fluid">
            <div class="btn-group rounded mx-2">
                <a class="navbar-brand" href="/">主页</a>
                <a class="navbar-brand" href="../blog/home">博客</a>
            </div>
            <div class="ml-auto d-flex">
                <!-- 按钮 -->
                <button id="btnToggleNightMode" class="btn btn-outline-light btn-sm mx-1 no-focus" data-toggle="tooltip"
                    title="夜间模式" data-placement="bottom">
                    <i class="bi bi-moon"></i>
                </button>
                <button id="btnUploadRecord" class="btn btn-outline-light btn-sm mx-1 no-focus" data-toggle="tooltip"
                    title="上传记录" data-placement="bottom">
                    <i class="bi bi-upload"></i>
                </button>
                <button id="btnDownloadRecord" class="btn btn-outline-light btn-sm mx-1 no-focus" data-toggle="tooltip"
                    title="下载记录" data-placement="bottom">
                    <i class="bi bi-download"></i>
                </button>
                <button id="btnOpenConfirmClearModal" class="btn btn-outline-light btn-sm mx-1 no-focus"
                    data-toggle="tooltip" title="清理缓存" data-placement="bottom">
                    <i class="bi bi-trash"></i>
                </button>
                <button id="auth-btn_homepage" class="btn btn-outline-light btn-sm mx-1 no-focus" data-toggle="tooltip"
                    title="登录" data-placement="bottom">
                    <i class="fas fa-sign-in-alt"></i>
                </button>

                <!-- 用户菜单 -->
                <div class="dropdown">
                    <button id="userAvatarButton" class="btn btn-outline-light btn-sm dropdown-toggle no-focus"
                        data-bs-toggle="dropdown" aria-expanded="false" title="用户菜单">
                        <i class="fas fa-user-circle" style="font-size: 1rem;"></i>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end shadow-sm text-start p-0">
                        <li class="dropdown-item disabled text-muted small d-flex align-items-center px-3 py-2">
                            <i class="fas fa-user me-2" style="width: 1.2rem; text-align: center;"></i>
                            ID:&nbsp;<span id="user-id">0</span>
                        </li>
                        <!-- <li>
                            <a class="dropdown-item small d-flex align-items-center px-3 py-2" onclick="viewProfile()">
                                <i class="fas fa-id-card text-primary me-2"
                                    style="width: 1.2rem; text-align: center;"></i>
                                个人信息
                            </a>
                        </li> -->
                        <li>
                            <a class="dropdown-item small d-flex align-items-center px-3 py-2 text-danger"
                                onclick="onLogoutClicked()">
                                <i class="fas fa-sign-out-alt me-2" style="width: 1.2rem; text-align: center;"></i>
                                注销
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </nav>

    <div class="container">
        <!-- 文件上传区域 -->
        <div id="dropZone" class="text-center">
            <button id="uploadButton">
                <i class="fas fa-arrow-up"></i>
            </button>
            <div style="margin-bottom: 10px;">将文件拖拽到这里上传</div>
            <input type="file" id="fileInput" class="form-control-file mb-2" multiple style="display: none;" />
            <label for="fileInput" class="btn btn-primary">选择文件上传</label>
        </div>

        <div class="row g-3">
            <!-- 上传文件列表 -->
            <div id="upload-area" class="col-md-8 upload-area">
                <div id="upload-container" class="d-none">
                    <div id="upload-files-table-container" class="file-list">
                        <table id="upload-files-table" class="table">
                            <thead>
                                <tr>
                                    <th>文件名</th>
                                    <th>大小</th>
                                    <th>进度</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="uploadFileList">
                                <!-- 动态添加上传文件信息 -->
                            </tbody>
                        </table>
                    </div>
                    <div class="text-right">
                        <button id="uploadFileButton" class="btn btn-primary btn-sm">上传文件</button>
                    </div>
                </div>
                <small class="mt-2">已上传文件</small>
                <div id="uploaded-files-table-container" class="file-list">
                    <table id="uploaded-files-table" class="table">
                        <thead>
                            <tr>
                                <th>文件名</th>
                                <th>大小</th>
                                <th>上传者</th>
                                <th>过期时间</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="uploadedFileList"></tbody>
                    </table>
                </div>
                <!-- 分页控件 -->
                <ul class="pagination align-items-center" id="uploaded_files_pagination">
                    <li class="page-item" id="prevPage">
                        <a class="page-link" href="javascript:void(0);" onclick="changePage(currentUploadedPage - 1)"
                            aria-label="Previous">
                            <span aria-hidden="true">&laquo;</span>
                        </a>
                    </li>
                    <li class="page-item disabled" id="pageInfo">
                        <span class="page-link">第 1 页 / 共 10 页</span>
                    </li>
                    <li class="page-item" id="nextPage">
                        <a class="page-link" href="javascript:void(0);" onclick="changePage(currentUploadedPage + 1)"
                            aria-label="Next">
                            <span aria-hidden="true">&raquo;</span>
                        </a>
                    </li>
                </ul>
            </div>


            <!-- 下载文件区域 -->
            <div id="download-area" class="col-md-4 download-area">
                <h6 class="mt-2">下载文件</h6>
                <div class="input-group mb-3">
                    <input type="text" id="fileId" class="form-control form-control-sm" placeholder="输入文件标识" required
                        data-bs-toggle="tooltip" data-bs-placement="bottom" title="请输入文件标识">
                    <div class="input-group-append">
                        <button id="downloadButton" class="btn btn-primary btn-sm ms-2">下载</button>
                    </div>
                </div>

                <h6 class="mt-2">文件下载排名</h6>
                <div id="downloadedRank" class="file-list">
                    <canvas id="downloadChart" width="400" height="250"></canvas>
                </div>

            </div>
        </div>
    </div>
    <!-- 预览容器（背景蒙版与内容容器组合） -->
    <div class="preview-container" id="preview-container">
        <div class="preview-content" id="preview-content">
            <div id="pdf-content">
                <div id="pdf-toolbar-top" class="d-flex flex-wrap justify-content-between align-items-center p-2">
                    <span class="d-flex align-items-center me-2" style="color:#8a8989;">
                        <span class="ms-2"><span id="current-zoom-scale">1</span></span>
                        <span>:<span id="total-pages-percent">1</span></span>
                    </span>
                    <span class="d-flex align-items-center me-2" style="color:#8a8989;">
                        <span class="ms-2"><span id="current-page-top">0</span> </span>
                        <span>/<span id="total-pages-top">0</span></span>
                    </span>
                    <button id="closePreview-pdf" class="btn btn-sm btn-danger px-2 py-1">
                        <i class="bi bi-x-circle"></i>
                    </button>
                </div>
                <div id="pdf-container">
                    <div id="outline-container">
                        <h3>目录</h3>
                        <!-- 目录项会在这里渲染 -->
                        <div id="outline-list"></div>
                    </div>
                    <div id="toggle-outline-btn-container">
                        <button id="btnTogglePdfOutline" class="tool-btn" title="目录">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                        <div id="resizer"></div>
                    </div>
                    <div id="canvas_toolbar_container">
                        <div id="toolbar-top-container">
                            <div id="tool-sidebar">
                                <button id="zoom-in" title="放大">
                                    <i class="bi bi-plus-circle"></i>
                                </button>
                                <button id="zoom-out" title="缩小">
                                    <i class="bi bi-dash-circle"></i>
                                </button>
                                <button id="reset-zoom" title="还原">
                                    <i class="bi bi-arrow-counterclockwise"></i>
                                </button>
                            </div>
                        </div>
                        <div id="pdf-canvas-container">
                            <canvas id="pdf-canvas"></canvas>
                        </div>
                    </div>
                    <div id="toggle-note-btn-container">
                        <button id="btnTogglePdfNote" class="btn-toggle-note" title="笔记">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                    </div>
                    <iframe id="note-iframe" class="d-none">
                    </iframe>
                </div>
                <div id="pdf-toolbar" class="d-flex flex-wrap justify-content-center align-items-center p-2">
                    <!-- 页码显示和跳转 -->
                    <button id="prevPage_preview" class="btn btn-sm btn-primary px-2 py-1 me-1">
                        <i class="bi bi-arrow-left-circle"></i>
                    </button>
                    <button id="nextPage_preview" class="btn btn-sm btn-primary px-2 py-1 me-2">
                        <i class="bi bi-arrow-right-circle"></i>
                    </button>
                    <span id="page-info" class="d-flex align-items-center me-2">
                        <input id="page-input" type="number" value="1" min="1"
                            style="width: 80px; height: 30px; margin-right: 5px;">
                        <button id="go-to-page" class="btn btn-sm btn-secondary px-2 py-1">跳转</button>
                    </span>
                    <button id="fullscreen-pdf" class="btn btn-sm btn-info px-2 py-1 me-2">
                        <i class="bi bi-arrows-fullscreen"></i>
                    </button>
                </div>
                <!-- </div> -->

            </div>
            <!-- 图片显示区域 -->
            <div id="image-content">
                <div class="d-flex flex-column">
                    <div id="img-toolbar" class="d-flex justify-content-end flex-row align-items-center rounded"
                        style="position: sticky; top:0">
                        <button id="closePreview-img" class="btn btn-sm btn-danger">
                            <i class="bi bi-x-circle"></i>
                        </button>
                    </div>
                    <img id="image-preview" class="img-fluid" alt="img-preview">
                </div>
            </div>
            <div id="text-content">
                <div class="d-flex flex-column">
                    <div id="text-toolbar" class="d-flex justify-content-end flex-row align-items-center rounded"
                        style="position: sticky; top:0">
                        <button id="closePreview-text" class="btn btn-sm btn-danger">
                            <i class="bi bi-x-circle"></i>
                        </button>
                    </div>
                    <div id="text-preview"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- 上传结果模态框 -->
    <div class="modal fade" id="uploadedModal" tabindex="-1" aria-labelledby="uploadedModalLabel">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- 上传成功表格 -->
                    <h5 style="color:red">注意：文件有效期默认为8小时，请及时下载，过期文件无法恢复</h5>
                    <table id="success-table" class="table table-bordered mb-4 table-responsive hidden">
                        <thead>
                            <tr>
                                <th>文件名</th>
                                <th>文件标识</th>
                                <th>文件全路径</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- 文件上传成功信息将插入到这里 -->
                        </tbody>
                    </table>

                    <!-- 上传失败表格 -->
                    <table id="failure-table" class="table table-bordered hidden">
                        <thead>
                            <tr>
                                <th>文件名</th>
                                <th>失败原因</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- 文件上传失败信息将插入到这里 -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- 上传记录的模态框 -->
    <div class="modal fade" id="uploadFilesHistoryModal" tabindex="-1" role="dialog" aria-labelledby="uploadModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="uploadModalLabel">上传记录</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <table class="table table-bordered" id="uploadTable">
                        <thead>
                            <tr>
                                <th><input type="checkbox" id="selectAllUploadedHistory" class="form-check-input"></th>
                                <!-- 全选框 -->
                                <th>文件名</th>
                                <th>文件标识</th>
                                <th>上传时间</th>
                                <th>状态</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- 上传记录列表 -->
                        </tbody>
                    </table>
                    <!-- 批量删除按钮 -->
                    <button type="button" id="btnBatchDeleteUploadedHistory" class="btn btn-danger btn-sm">
                        批量删除
                    </button>
                    <!-- 分页控件 -->
                    <nav aria-label="Page navigation">
                        <ul class="pagination justify-content-center" id="uploadedFileHistoryPagination">
                            <!-- 分页按钮将动态添加到这里 -->
                        </ul>
                    </nav>
                    <table class="table table-bordered" id="uploadTableLocal">
                        <thead>
                            <tr>
                                <th>文件名</th>
                                <th>文件标识</th>
                                <th>上传时间</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- 上传记录列表 -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- 下载记录的模态框 -->
    <div class="modal fade" id="downloadedFilesHistoryModal" tabindex="-1" role="dialog"
        aria-labelledby="downloadModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="downloadModalLabel">下载记录</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <table class="table table-bordered" id="downloadTable">
                        <thead>
                            <tr>
                                <th>文件名</th>
                                <th>文件标识</th>
                                <th>下载时间</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- 下载记录列表 -->
                        </tbody>
                    </table>
                    <!-- 分页控件 -->
                    <nav aria-label="Page navigation">
                        <ul class="pagination justify-content-center" id="downloadedFileHistoryPagination">
                            <!-- 分页按钮将动态添加到这里 -->
                        </ul>
                    </nav>
                    <table class="table table-bordered" id="downloadTableLocal">
                        <thead>
                            <tr>
                                <th>文件名</th>
                                <th>文件标识</th>
                                <th>下载时间</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- 下载记录列表 -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- 登录弹窗 -->
    <div class="modal fade" id="loginModal" tabindex="-1" aria-labelledby="loginModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="loginModalLabel">登录</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- 登录选项按钮 -->
                    <div class="d-flex flex-column">
                        <!-- Github 登录按钮 -->
                        <button class="btn btn-dark mb-2" id="btn_login_github">
                            <i class="fab fa-github"></i> 使用 Github 登录
                        </button>

                        <!-- <button class="btn btn-danger mb-2 disabled">
                            <i class="fab fa-google"></i> 使用 Google 登录（暂不支持）
                        </button>

                        <button class="btn btn-success mb-2 disabled">
                            <i class="fab fa-weixin"></i> 使用微信登录（暂不支持）
                        </button>

                        <button class="btn btn-info mb-2 disabled">
                            <i class="fas fa-phone"></i> 使用手机号登录（暂不支持）
                        </button> -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 加载页面弹窗的HTML -->
    <div id="loadingModal">
        <div class="waiting-spinner">
            <div class="spinner-border" role="status">
                <span class="sr-only"></span>
            </div>
        </div>
    </div>
    <!-- 上传文件等待弹窗 -->
    <div id="waitingModal" class="modal" tabindex="-1" role="dialog" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog" role="document">
            <div id="loading-content" class="modal-content text-center">
                <div class="modal-body">
                    <div class="loading-spinner">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">正在加载...</span>
                        </div>
                        <div>正在上传文件...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 清理缓存警告模态框 -->
    <div class="modal" id="confirmClearCacheModal" tabindex="-1" role="dialog" aria-labelledby="confirmModalLabel"
        aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="confirmModalLabel">确认操作</h5>
                </div>
                <div class="modal-body">
                    <div class="container mt-2">
                        <p>您确定要清理所有缓存吗？此操作不可撤销。</p>
                        <ul id="cache-list" class="list-group">
                            <!-- 动态生成的列表将插入到这里 -->
                        </ul>
                        <p id="total-cache-size" class="text-muted">加载中...</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" id="btnCancelClearCache" class="btn btn-secondary"
                        data-dismiss="modal">取消</button>
                    <button type="button" id="btnConfirmClearCache" class="btn btn-danger">确定</button>
                </div>
            </div>
        </div>
    </div>
    <!-- 删除文件警告模态框 -->
    <div class="modal confirm-delete-modal" id="confirmDeleteFileModal" tabindex="-1" role="dialog"
        aria-labelledby="confirmDeleteModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content border-danger">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title" id="confirmDeleteModalLabel">
                        <i class="fas fa-exclamation-triangle"></i> 确认删除文件
                    </h5>
                </div>
                <div class="modal-body">
                    <div class="container mt-2">
                        <p><strong>警告：</strong> 您确定要删除文件吗？此操作不可撤销。</p>
                        <table class="table table-bordered">
                            <thead>
                                <tr>
                                    <th style="width: 5%;">序号</th> <!-- 序号列，减小宽度 -->
                                    <th>文件名</th> <!-- 文件名列 -->
                                </tr>
                            </thead>
                            <tbody id="delete-file-list">
                                <!-- 动态生成的文件列表将插入到这里 -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" id="btnCancelDeleteFile" class="btn btn-secondary"
                        data-bs-dismiss="modal">取消</button>
                    <button type="button" id="btnConfirmDeleteFile" class="btn btn-danger">确定</button>
                </div>
            </div>
        </div>
    </div>


</body>
<script src="../js/jquery.min.js"></script>
<script src="../js/constDefine.js"></script>
<script src="../js/common.js"></script>
<script src="../js/util.js"></script>
<script src="../js/bootstrap.bundle.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0/dist/chartjs-plugin-datalabels.min.js">
</script>
<script>
    // 每页显示条数
    const recordsPerPage = 10;
    // 当前页
    let currentUploadedFileHistoryPage = 1;
    let currentDownloadedFileHistoryPage = 1;

    // 更新上传记录分页
    function updateUploadPagination(totalRecords) {
        const totalPages = Math.ceil(totalRecords / recordsPerPage);
        const pagination = document.getElementById('uploadedFileHistoryPagination');
        pagination.innerHTML = ''; // 清空现有分页内容

        // 创建 "上一页" 按钮
        const prevButton = document.createElement('li');
        prevButton.classList.add('page-item');
        if (currentUploadedFileHistoryPage === 1 || totalPages === 0) {
            prevButton.classList.add('disabled'); // 如果是第一页，禁用上一页按钮
        }
        prevButton.innerHTML = `<a class="page-link" href="javascript:void(0);" onclick="loadUploadPage(${currentUploadedFileHistoryPage - 1})">&laquo;</a>`;
        pagination.appendChild(prevButton);

        // 添加当前页 / 总页数文本
        const pageInfo = document.createElement('li');
        pageInfo.classList.add('page-item', 'disabled');
        pageInfo.innerHTML = `<span class="page-link">第 ${currentUploadedFileHistoryPage} 页 / 共 ${totalPages} 页</span>`;
        pagination.appendChild(pageInfo);

        // 创建 "下一页" 按钮
        const nextButton = document.createElement('li');
        nextButton.classList.add('page-item');
        if (currentUploadedFileHistoryPage === totalPages || totalPages === 0) {
            nextButton.classList.add('disabled'); // 如果是最后一页，禁用下一页按钮
        }
        nextButton.innerHTML = `<a class="page-link" href="javascript:void(0);" onclick="loadUploadPage(${currentUploadedFileHistoryPage + 1})">&raquo;</a>`;
        pagination.appendChild(nextButton);
    }
    // 更新下载记录分页
    function updateDownloadPagination(totalRecords) {
        const totalPages = Math.ceil(totalRecords / recordsPerPage);
        const pagination = document.getElementById('downloadedFileHistoryPagination');
        pagination.innerHTML = ''; // 清空现有分页内容

        // 创建 "上一页" 按钮
        const prevButton = document.createElement('li');
        prevButton.classList.add('page-item');
        if (currentDownloadedFileHistoryPage === 1 || totalPages === 0) {
            prevButton.classList.add('disabled'); // 如果是第一页，禁用上一页按钮
        }
        prevButton.innerHTML = `<a class="page-link" href="javascript:void(0);" onclick="loadDownloadPage(${currentDownloadedFileHistoryPage - 1})">&laquo;</a>`;
        pagination.appendChild(prevButton);

        // 添加当前页 / 总页数文本
        const pageInfo = document.createElement('li');
        pageInfo.classList.add('page-item', 'disabled');
        pageInfo.innerHTML = `<span class="page-link">第 ${currentDownloadedFileHistoryPage} 页 / 共 ${totalPages} 页</span>`;
        pagination.appendChild(pageInfo);

        // 创建 "下一页" 按钮
        const nextButton = document.createElement('li');
        nextButton.classList.add('page-item');
        if (currentDownloadedFileHistoryPage === totalPages || totalPages === 0) {
            nextButton.classList.add('disabled'); // 如果是最后一页，禁用下一页按钮
        }
        nextButton.innerHTML = `<a class="page-link" href="javascript:void(0);" onclick="loadDownloadPage(${currentDownloadedFileHistoryPage + 1})">&raquo;</a>`;
        pagination.appendChild(nextButton);
    }

    // 加载上传记录页面数据
    async function loadUploadPage(pageNum) {
        try {
            const response = await fetch(`${backend_yingwu}/files/uploads?page=${pageNum}&limit=${recordsPerPage}`, {
                credentials: 'include'
            });
            if (response.ok) {
                const data = await response.json();
                renderUploadRecords(data.files);
                currentUploadedFileHistoryPage = pageNum;
                updateUploadPagination(data.totalCount);
            } else {
                showToast("响应失败");
            }
        } catch (error) {
            console.error(error);
        }
    }

    // 加载下载记录页面数据
    async function loadDownloadPage(pageNum) {
        try {
            const response = await fetch(`${backend_yingwu}/files/downloads?page=${pageNum}&limit=${recordsPerPage}`, {
                credentials: 'include'
            });

            if (response.ok) {
                const data = await response.json();
                renderDownloadRecords(data.files);
                currentDownloadedFileHistoryPage = pageNum;
                updateDownloadPagination(data.totalCount);
            } else {
                showToast("响应失败");
            }
        } catch (error) {
            console.error(error);
        }
    }

    function extractUploadRecords() {
        const uploadTableBody = document.getElementById('uploadTable').getElementsByTagName('tbody')[0];
        const rows = uploadTableBody.getElementsByTagName('tr');

        const records = [];
        Array.from(rows).forEach(row => {
            const filename = row.cells[1].textContent.trim();
            const hash = row.cells[2].querySelector('.label-style').textContent.trim();
            const uploadedAt = row.cells[3].textContent.trim();

            records.push({
                filename: filename,
                hash: hash,
                uploaded_at: uploadedAt
            });
        });

        return records;
    }

    // 全选框点击事件
    document.getElementById('selectAllUploadedHistory').addEventListener('change', function () {
        const isChecked = event.target.checked;
        const fileCheckboxes = document.querySelectorAll('.file-select');
        fileCheckboxes.forEach(checkbox => {
            checkbox.checked = isChecked;
        });
    });

    // 获取所有选中的文件哈希
    function getSelectedFileHashes() {
        const selectedHashes = [];
        const fileCheckboxes = document.querySelectorAll('.file-select:checked');
        fileCheckboxes.forEach(checkbox => {
            selectedHashes.push(checkbox.getAttribute('data-hash'));
        });
        return selectedHashes;
    }

    // 获取所有选中的文件哈希、文件名
    function getSelectedFileInfo() {
        const selectedFiles = [];
        const fileCheckboxes = document.querySelectorAll('.file-select:checked'); // 获取所有选中的复选框
        fileCheckboxes.forEach(checkbox => {
            // 获取当前选中行的文件哈希和文件名
            const hash = checkbox.getAttribute('data-hash');
            const filename = checkbox.closest('tr').querySelector('td:nth-child(2)').textContent; // 获取文件名
            selectedFiles.push({ hash, filename });
        });
        return selectedFiles;
    }

    async function handleLockFiles(fileIDs, status) {
        const response = await lockFiles(fileIDs, status);
        const operation = status ? "锁定" : "解锁";
        if (response.ok) {
            const data = await response.json();
            const { successFiles, failureCount } = data.result;
            if (successFiles && successFiles.length > 0) {
                if (!failureCount) {
                    showToast("已" + operation);
                }
                else {
                    showToast("成功" + operation + successFiles.length + "个，失败 " + failureCount + "个");
                }
                const status = localStorage.getItem("blog_website_login");
                if (status === "true") {
                    loadUploadPage(currentUploadedFileHistoryPage);
                }
            }
            else {
                showToast(operation + "失败", "top-right", "bg-warning");
            }
        }
        else {
            showToast(operation + "失败", "top-right", "bg-warning");
        }
    }

    async function handleDeleteFiles(fileIDs) {
        const response = await deleteFiles(fileIDs);
        if (response.ok) {
            const data = await response.json();
            const { successFiles, failureCount } = data.result;
            if (successFiles && successFiles.length > 0) {
                if (!failureCount) {
                    showToast("删除成功");
                }
                else {
                    showToast("成功 " + successFiles.length + "个，失败 " + failureCount + "个");
                }
                const status = localStorage.getItem("blog_website_login");
                if (status === "true") {
                    loadUploadPage(currentUploadedFileHistoryPage);
                }
            }
            else {
                showToast("删除失败", "top-right", "bg-warning");
            }
        }
        else {
            showToast("删除失败", "top-right", "bg-warning");
        }
    }

    // 批量删除按钮点击事件
    document.getElementById('btnBatchDeleteUploadedHistory').addEventListener('click', async function () {
        const selectedFiles = getSelectedFileInfo();
        if (selectedFiles.length > 0) {
            openConfirmDeleteFileModal(selectedFiles);
        } else {
            showToast("请选择要删除的文件", "top-right", 'bg-info');
        }
    });

    // 渲染上传记录到表格
    function renderUploadRecords(records) {
        const uploadTableBody = document.getElementById('uploadTable').getElementsByTagName('tbody')[0];
        uploadTableBody.innerHTML = ''; // 清空现有记录

        records.forEach(record => {
            const label = record.hash;
            const uploadedAt = toLocalTime(record.uploaded_at);
            const locked = record.locked;
            let btnLock;
            if (locked) {
                btnLock = `
                <button class="btn btn-sm btn-success" onclick="lockFile('${record.hash}',false)">
                    <i class="fas fa-lock"></i>
                </button>
            `;
            } else {
                btnLock = `
                    <button class="btn btn-sm btn-warning" onclick="lockFile('${record.hash}',true)">
                        <i class="fas fa-unlock"></i>
                    </button>
                `;
            }
            const row = document.createElement('tr');

            row.innerHTML = `
                <td><input type="checkbox" class="file-select" data-hash="${record.hash}"></td>
                <td>${record.filename}</td>
                <td><span class="label-style">${label}</span></td>
                <td>${uploadedAt}</td>
                <td>${btnLock}</td>
                <td>
                    <button class="btn btn-danger btn-sm" onclick="deleteFile({hash: '${record.hash}', filename: '${record.filename}'})">删除</button>
                </td>
                `;
            uploadTableBody.appendChild(row);
        });
    }

    // 渲染下载记录到表格
    function renderDownloadRecords(records) {
        const downloadTableBody = document.getElementById('downloadTable').getElementsByTagName('tbody')[0];
        downloadTableBody.innerHTML = ''; // 清空现有记录

        records.forEach(record => {
            const label = record.hash;
            // const fullPath = `${backend_yingwu}/files/download/${label}`;
            const downloadedAt = toLocalTime(record.downloaded_at);
            const row = document.createElement('tr');
            row.innerHTML = `
        <td>${record.filename}</td>
        <td><span class="label-style">${label}</span></td>
        <td>${downloadedAt}</td>
        `;
            downloadTableBody.appendChild(row);
        });
    }

    // 格式化文件大小（例如：1 MB, 200 KB）
    function formatFileSize(bytes) {
        const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
        if (bytes === 0) return '0 Byte';
        const i = parseInt(Math.floor(Math.log(bytes) / Math.log(1024)));
        return Math.round(bytes / Math.pow(1024, i)) + ' ' + sizes[i];
    }

    // 白夜模式切换
    function toggleNightMode() {
        const nightModeActive = $('body').hasClass('night-mode');
        $('body').toggleClass('night-mode');
        $("#dropZone").toggleClass("night-mode");
        $("#upload-area").toggleClass("night-mode");
        $("#uploaded-files-table-container").toggleClass("night-mode");
        $("#upload-files-table-container").toggleClass("night-mode");
        $("#uploaded_files_pagination").toggleClass("night-mode");
        $("#download-area").toggleClass("night-mode");
        $("#downloadedRank").toggleClass("night-mode");
        $("#fileId").toggleClass("night-mode");
        $(".modal-content").toggleClass("modal-night-mode");
        $(".table").toggleClass("modal-night-mode");
        $(".page-link").toggleClass("night-mode");
        $(".list-group-item").toggleClass("night-mode");
        $(".list-group-item").toggleClass("night-mode");

        // 更新按钮图标和样式
        if (nightModeActive) {
            $('#btnToggleNightMode i').removeClass('bi-sun').addClass('bi-moon');
            $('#btnToggleNightMode').attr('title', '白天模式');
            setLocalStorge(SettingType.StylePreference, CustomStyle.WhiteMode);
        } else {
            $('#btnToggleNightMode i').removeClass('bi-moon').addClass('bi-sun');
            $('#btnToggleNightMode').attr('title', '夜间模式');
            setLocalStorge(SettingType.StylePreference, CustomStyle.NightMode);
        }
    }

</script>
<script>
    // 分页参数
    let currentUploadedPage = 1;  // 当前页
    const UploadedFilesPerPage = 9;  // 每页显示的文件数

    // 更新分页信息
    function updateUploadedFilesPagination(totalCount, page) {
        const totalPages = Math.ceil(totalCount / UploadedFilesPerPage);

        // 更新页码信息
        document.getElementById('pageInfo').innerHTML = `第 ${page} 页 / 共 ${totalPages} 页`;

        // 控制上一页、下一页按钮的禁用状态
        document.getElementById('prevPage').classList.toggle('disabled', page <= 1);
        document.getElementById('nextPage').classList.toggle('disabled', page >= totalPages);
    }

    // 切换分页
    function changePage(page) {
        if (page < 1) return;
        fetch(`${backend_yingwu}/files?page=${page}&limit=${UploadedFilesPerPage}`,
            {
                method: 'GET',
                credentials: 'include'
            }
        )
            .then(response => response.json())
            .then(data => {
                renderUploadedFiles(data.files);
                updateUploadedFilesPagination(data.totalCount, page);
                currentUploadedPage = page;
            })
            .catch(error => console.error('Error loading files:', error));
    }

    const requestDownloadedFilesRank = () => {
        fetch(`${backend_yingwu}/files/downloadRank`,
            {
                method: 'GET',
                credentials: 'include'
            }
        )
            .then(response => response.json())
            .then(data => {
                renderDownloadedFilesRank(data.files);
            })
            .catch(error => console.error('Error loading downloaded files rank:', error));
    }

    // 上传文件结果弹窗
    const modalElement = document.getElementById('uploadedModal');
    const uploadedModal = new bootstrap.Modal(modalElement, {
        backdrop: 'static',  // 禁止点击外部区域关闭模态框
        keyboard: false      // 禁止按下 ESC 键关闭模态框
    });
    // 初始化工具提示
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    const tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });

    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');
    const uploadFileList = document.getElementById('uploadFileList');
    const uploadedFileList = document.getElementById('uploadedFileList');
    const downloadFileList = document.getElementById('downloadFileList');
    const maxFileSize = 1 * 1024 * 1024 * 1024; // 1GB
    let selectedFiles = [];

    dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.classList.add('dragover');
    });

    dropZone.addEventListener('dragleave', () => {
        dropZone.classList.remove('dragover');
    });

    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('dragover');
        $("#upload-container").removeClass("d-none");
        handleFiles(e.dataTransfer.files);
    });

    fileInput.addEventListener('change', (e) => {
        $("#upload-container").removeClass("d-none");
        handleFiles(e.target.files);
    });

    function handleFiles(files) {
        for (let i = 0; i < files.length; i++) {
            if (files[i].size > maxFileSize) {
                showToast(`${files[i].name} 超过最大上传限制 (1GB)`, "top-right", "bg-warning");
                continue;
            }
            // 检查文件名是否重复
            const isDuplicate = selectedFiles.some(file => file.name === files[i].name);
            if (isDuplicate) {
                continue;
            }
            selectedFiles.push(files[i]);

            const row = document.createElement('tr');

            const fileNameCell = document.createElement('td');
            const fileNameSpan = document.createElement('span');
            fileNameSpan.style.color = 'gray';  // 设置文本颜色为灰色
            fileNameSpan.classList.add('file-name');
            fileNameSpan.textContent = files[i].name;
            fileNameCell.appendChild(fileNameSpan);

            const fileSizeCell = document.createElement('td');
            const sizeSmall = document.createElement('small');
            sizeSmall.textContent = `${(files[i].size / (1024 * 1024)).toFixed(2)} MB`;
            fileSizeCell.appendChild(sizeSmall);

            const progressCell = document.createElement('td');
            const progressBar = document.createElement('div');
            progressBar.className = 'progress';
            const progress = document.createElement('div');
            progress.className = 'progress-bar progress-bar-striped progress-bar-animated';
            progress.style.width = '0%'; // 初始进度
            progress.setAttribute('role', 'progressbar');
            progress.setAttribute('aria-valuenow', '0');
            progress.setAttribute('aria-valuemin', '0');
            progress.setAttribute('aria-valuemax', '100');
            progressBar.appendChild(progress);
            progressCell.appendChild(progressBar);

            const actionCell = document.createElement('td');
            const cancelButton = document.createElement('button');
            cancelButton.className = 'btn btn-danger btn-sm';
            cancelButton.textContent = '取消';
            cancelButton.onclick = () => removeFile(row, progress, cancelButton); // 调用取消函数
            actionCell.appendChild(cancelButton);

            row.appendChild(fileNameCell);
            row.appendChild(fileSizeCell);
            row.appendChild(progressCell);
            row.appendChild(actionCell);
            uploadFileList.appendChild(row);
        }
    }

    /**
     * 合并成功和失败的文件数据，并更新 sessionStorage 中的 uploaded_files
     * @param {Array} successFiles 新上传的成功文件数组
     * @param {Array} failureFiles 新上传的失败文件数组
     */
    function mergeUploadedFilesHistory(successFiles, failureFiles) {
        // 从 sessionStorage 中获取已上传的文件数据
        const uploadedFiles = JSON.parse(sessionStorage.getItem('uploaded_files') || '{}');

        // 提取现有的 successFiles 和 failureFiles，确保它们是数组类型
        const storedSuccessFiles = Array.isArray(uploadedFiles.successFiles) ? uploadedFiles.successFiles : [];
        const storedFailureFiles = Array.isArray(uploadedFiles.failureFiles) ? uploadedFiles.failureFiles : [];

        // 确保传入的 successFiles 和 failureFiles 是数组类型
        const newSuccessFiles = Array.isArray(successFiles) ? successFiles : [];
        const newFailureFiles = Array.isArray(failureFiles) ? failureFiles : [];

        // 合并新的成功文件和失败文件
        const mergedSuccessFiles = [...storedSuccessFiles, ...newSuccessFiles];
        const mergedFailureFiles = [...storedFailureFiles, ...newFailureFiles];

        // 更新 uploadedFiles 对象
        uploadedFiles.successFiles = mergedSuccessFiles;
        uploadedFiles.failureFiles = mergedFailureFiles;

        // 将合并后的数据保存回 sessionStorage
        sessionStorage.setItem('uploaded_files', JSON.stringify(uploadedFiles));
    }

    function mergeDownloadedFilesHistory(files) {
        // 从 sessionStorage 中获取已下载的文件数据
        const storedFiles = JSON.parse(sessionStorage.getItem('downloaded_files') || '[]');

        // 确保传入的 files 是数组类型
        const newFiles = Array.isArray(files) ? files : [];

        // 合并新的文件和存储的文件
        const mergedFiles = [...storedFiles, ...newFiles];

        // 将合并后的数据保存回 sessionStorage
        sessionStorage.setItem('downloaded_files', JSON.stringify(mergedFiles));
    }

    async function lockFile(fileID, status) {
        let fileIDs = [];
        fileIDs.push(fileID);
        return handleLockFiles(fileIDs, status);
    }

    async function onConfirmDeleteFileBtnClicked() {
        const modal = document.getElementById("confirmDeleteFileModal");
        const hashes = JSON.parse(modal.dataset.hashes);
        if (hashes) {
            await handleDeleteFiles(hashes);
        }
        else {
            showToast("没有可删除的文件", "top-right", "bg-info");
        }
        confirmDeleteFileModal.hide();
    }

    async function deleteFile(file) {
        let files = [];
        files.push(file);
        openConfirmDeleteFileModal(files);
    }

    async function deleteFiles(fileIDs) {
        try {
            const response = await fetch(`${backend_yingwu}/files/delete`, {
                method: 'POST',
                body: JSON.stringify({
                    files: fileIDs
                }),
                credentials: 'include',
            });
            return response;
        } catch (error) {
            console.error(error);
            showToast("删除失败", 'top-right', 'bg-danger');
            return [];
        }
    }

    async function lockFiles(fileIDs, status) {
        try {
            const response = await fetch(`${backend_yingwu}/files/lock/${status}`, {
                method: 'POST',
                body: JSON.stringify({
                    files: fileIDs
                }),
                credentials: 'include',
            });
            return response;
        } catch (error) {
            console.error(error);
            showToast("操作失败", 'top-right', 'bg-danger');
            return [];
        }
    }

    const downloadFile = async (fileID) => {
        try {
            const downloadResponse = await fetch(`${backend_yingwu}/files/download/${fileID}`, {
                credentials: 'include'
            });

            // 检查响应状态
            if (downloadResponse.ok) {
                const contentType = downloadResponse.headers.get('Content-Type');
                if (contentType && contentType.includes('application/json')) {
                    const respJson = await downloadResponse.json();
                    if (respJson) {
                        console.log(respJson);
                        showToast("下载失败", 'top-right', 'bg-warning');
                        return;
                    }
                } else {
                    // 处理文件响应
                    let fileName = '未命名文件';
                    const contentDisposition = downloadResponse.headers.get('Content-Disposition');
                    if (contentDisposition) {
                        const filenameMatch = contentDisposition.match(/filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/);
                        if (filenameMatch && filenameMatch[1]) {
                            // 去除引号
                            fileName = filenameMatch[1].replace(/['"]/g, '');
                            // 去除 UTF-8
                            fileName = fileName.replace(/UTF-8/g, '').trim(); // 去除所有的 UTF-8 并去掉多余空格
                            // 解码文件名
                            fileName = decodeURIComponent(fileName);
                        }
                    }
                    const blob = await downloadResponse.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;
                    a.download = fileName; // 指定下载文件名
                    document.body.appendChild(a);
                    a.click(); // 仅下载文件
                    document.body.removeChild(a); // 清理
                    window.URL.revokeObjectURL(url); // 释放 URL 对象

                    // 记录在案
                    const downloadedFile = {
                        fileName,
                        label: "file_" + fileID.substring(0, 6),
                        downloadedAt: new Date().toISOString()
                    }
                    const arr = []
                    mergeDownloadedFilesHistory([...arr, downloadedFile]);
                }
            }
            else if (downloadResponse.status === 403) {
                showToast("文件已被所有者锁定", 'top-right', 'bg-warning');
            }
            else {
                showToast("下载失败", 'top-right', 'bg-warning');
            }
        } catch (error) {
            showToast("下载失败", 'top-right', 'bg-warning');
        }
    }

    const previewFile = async (fileID) => {
        document.getElementById('preview-container').style.display = 'flex'; // 显示预览容器
        const requestUrl = `${backend_yingwu}/files/preview/${fileID}`;
        let cache = null;
        let cached = false;
        try {
            cache = await caches.open('file-cache'); // 打开缓存
            // 尝试从缓存中获取文件
            const cachedResponse = await cache.match(requestUrl); // 根据 fileID 查找缓存中的文件

            if (cachedResponse) {
                // 如果缓存中有文件，直接获取 Blob 和文件名
                const cachedBlob = await cachedResponse.blob();
                let fileExtension = cachedResponse.headers.get('X-File-Extension') || '';
                fileExtension = decodeURIComponent(fileExtension);

                const cacheTimestamp = cachedResponse.headers.get('X-Cache-Timestamp');
                const currentTime = Date.now();
                const expirationTime = 30 * 24 * 60 * 60 * 1000;  // 设置过期时间（30天，单位：毫秒）
                // 判断缓存是否过期
                if (cacheTimestamp && (currentTime - parseInt(cacheTimestamp)) > expirationTime) {
                    // 如果缓存已过期，删除缓存并返回空
                    await cache.delete(requestUrl);
                    console.log("缓存过期，已删除");
                    return;
                }
                const blobUrl = URL.createObjectURL(cachedBlob);
                openPreview(fileExtension, blobUrl, fileID);
                setTimeout(() => URL.revokeObjectURL(blobUrl), 60000 * 30);
                cached = true;
            }
        } catch (error) {
            console.log("缓存错误");
        }

        if (!cached) {

            try {
                const downloadResponse = await fetch(requestUrl, {
                    credentials: 'include'
                });

                // 检查响应状态
                if (downloadResponse.ok) {
                    const contentType = downloadResponse.headers.get('Content-Type');
                    if (contentType && contentType.includes('application/json')) {
                        const respJson = await downloadResponse.json();
                        if (respJson) {
                            showToast("文件下载失败", 'top-right', 'bg-warning');
                            return;
                        }
                    } else {
                        // 处理文件响应
                        let fileName = '未命名文件';
                        const contentDisposition = downloadResponse.headers.get('Content-Disposition');
                        if (contentDisposition) {
                            const filenameMatch = contentDisposition.match(/filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/);
                            if (filenameMatch && filenameMatch[1]) {
                                // 去除引号
                                fileName = filenameMatch[1].replace(/['"]/g, '');
                                // 去除 UTF-8
                                fileName = fileName.replace(/UTF-8/g, '').trim(); // 去除所有的 UTF-8 并去掉多余空格
                                // 解码文件名
                                fileName = decodeURIComponent(fileName);
                            }
                        }
                        // 获取 Blob 数据
                        const blob = await downloadResponse.blob();

                        // 创建 Blob URL
                        const blobUrl = URL.createObjectURL(blob);
                        let fileExtension = fileName.substring(fileName.lastIndexOf('.') + 1);
                        fileExtension = encodeURIComponent(fileExtension);
                        openPreview(fileExtension, blobUrl, fileID);
                        setTimeout(() => URL.revokeObjectURL(blobUrl), 60000 * 30);

                        // 将 Blob 数据和文件名一起存储到缓存
                        if (cache) {
                            const responseWithMetadata = new Response(blob, {
                                headers: {
                                    'X-File-Extension': fileExtension, // 存储文件扩展名
                                    'X-Cache-Timestamp': Date.now().toString()
                                }
                            });

                            // 将 Response 存入缓存
                            await cache.put(requestUrl, responseWithMetadata);
                        }
                    }
                }
                else if (downloadResponse.status === 403) {
                    showToast("文件已被所有者锁定", 'top-right', 'bg-warning');
                    closePreview();
                    return;
                }
                else {
                    showToast("文件不存在", 'top-right', 'bg-warning');
                    closePreview();
                    return;
                }
            } catch (error) {
                console.error(error);
                showToast("文件下载失败", 'top-right', 'bg-warning');
                closePreview();
                return;
            }
        }

        // 请求笔记id
        let badurl = window.location.origin;
        if (badurl.endsWith("/")) {
            badurl = badurl + "404";
        }
        else {
            badurl = badurl + "/404";
            origin = origin + "/";
        }
        const iframe = document.getElementById('note-iframe');
        try {
            const requrl = `${backend_yingwu}/files/note_info/${fileID}`;
            const response = await fetch(requrl, {
                credentials: 'include'
            });
            // 检查响应状态
            if (response.ok) {
                const resp = await response.json();
                let { noteID, noteTitle } = resp.result;
                noteTitle = noteTitle ? noteTitle + " 的笔记" : "笔记";
                let origin = window.location.origin;
                const noteUrl = noteID ? `${origin}${Page_Blog_Write_Through}?id=${noteID}&title=${noteTitle}` : badurl
                iframe.src = noteUrl;
            }
            else {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
        } catch (err) {
            iframe.src = badurl;
        }
    }

    function removeFile(element) {
        const row = element.closest('tr'); // 获取当前行
        const fileName = row.cells[0].textContent; // 获取第一列（文件名）

        // 从 selectedFiles 中移除对应的文件
        selectedFiles = selectedFiles.filter(file => file.name !== fileName);

        // 获取进度条和取消按钮
        const progressBar = row.querySelector('.progress-bar');
        const cancelButton = row.querySelector('button');

        // 将进度条变灰并停止动画
        progressBar.className = 'progress-bar'; // 移除动画和样式
        progressBar.style.backgroundColor = '#6c757d'; // 设置灰色
        progressBar.style.width = '100%'; // 显示为已取消状态

        // 禁用取消按钮并变灰
        cancelButton.className = 'btn btn-secondary btn-sm'; // 改为次要按钮
        cancelButton.disabled = true; // 禁用按钮
        cancelButton.textContent = '已取消'; // 改变按钮文本
    }

    const uploadFile = async () => {
        if (selectedFiles.length === 0) {
            showToast("请拖拽或选择文件上传", "top-right", "bg-info");
            return;
        }
        const formData = new FormData();
        selectedFiles.forEach(file => formData.append('files', file));
        $('#waitingModal').modal('show');
        try {
            const response = await fetch(`${backend_yingwu}/files/upload`, {
                method: 'POST',
                body: formData,
                credentials: 'include'
            });
            if (response.ok) {
                const data = await response.json();
                if (data.result) {
                    const { successFiles, failureFiles, failureCount, message } = data.result;
                    selectedFiles = [];
                    uploadFileList.innerHTML = '';
                    fileInput.value = '';

                    // 修改文本为上传成功
                    const spinnerText = $('#waitingModal .loading-spinner div:nth-child(2)');
                    spinnerText.text('上传成功！');
                    $('#waitingModal').modal('hide');
                    if (successFiles && successFiles.length > 0) {
                        successFiles.forEach(file => {
                            file.uploadedAt = new Date().toISOString();
                        });
                        renderSuccessFiles(successFiles);
                    }
                    if (failureCount > 0 && failureFiles && failureFiles.length > 0) {
                        failureFiles.forEach(file => {
                            file.uploadedAt = new Date().toISOString();
                        });
                        renderFailureFiles(failureFiles);
                    }
                    uploadedModal.show();
                    // 保存记录到本地
                    mergeUploadedFilesHistory(successFiles, failureFiles);
                }
            }
            else {
                // 修改文本为上传失败
                const spinnerText = $('#waitingModal .loading-spinner div:nth-child(2)');
                spinnerText.text('上传失败！');
                $('#waitingModal').modal('hide');
            }
        } catch (error) {
            console.error(error);
            const spinnerText = $('#waitingModal .loading-spinner div:nth-child(2)');
            spinnerText.text('上传失败！');
            $('#waitingModal').modal('hide');
        }
    }
    document.getElementById('uploadFileButton').onclick = uploadFile;

    const fileIdInput = document.getElementById('fileId');
    const downloadButton = document.getElementById('downloadButton');

    // 监听输入框变化
    fileIdInput.addEventListener('input', function () {
        const tooltip = bootstrap.Tooltip.getInstance(this);
        if (this.value) {
            if (tooltip) {
                tooltip.dispose(); // 移除工具提示
            }
        } else {
            if (!tooltip) {
                new bootstrap.Tooltip(this).show(); // 显示工具提示
            } else {
                tooltip.show(); // 确保工具提示可见
            }
        }
    });

    downloadButton.onclick = async function () {
        const fileId = fileIdInput.value;

        if (!fileId) {
            bootstrap.Tooltip.getInstance(fileIdInput) || new bootstrap.Tooltip(fileIdInput).show(); // 显示工具提示
            return;
        }

        // 如果输入框不为空，继续下载
        downloadFile(fileId);
    };

    function renderDownloadedFilesRank(files) {
        // 提取文件名和下载量，确保下载量为整数
        const labels = files.map(file => file.filename);
        const downloadCounts = files.map(file => Math.floor(file.download_count)); // 保证下载量为整数

        // 设置最大文件名长度为 8，超出部分使用 '...' 表示
        const maxFilenameLength = 50; // 设置文件名的最大字符数
        const truncatedLabels = labels.map(filename => {
            if (filename.length > maxFilenameLength) {
                return filename.substring(0, maxFilenameLength) + '...';
            }
            return filename;
        });

        // 创建柱状图
        const ctx = document.getElementById('downloadChart').getContext('2d');
        const chart = new Chart(ctx, {
            type: 'bar',  // 设置图表类型为柱状图
            data: {
                labels: truncatedLabels,  // 截断后的文件名
                datasets: [{
                    label: '下载量',
                    data: downloadCounts,  // 下载量
                    backgroundColor: 'rgba(54, 162, 235, 0.2)',  // 柱状图的背景色
                    borderColor: 'rgba(54, 162, 235, 1)',  // 柱状图的边框色
                    borderWidth: 1,
                    barThickness: 20,  // 设置柱子的固定宽度
                    categoryPercentage: 0.6,  // 控制每个类别的宽度
                    barPercentage: 0.8,  // 控制柱子在类别宽度中的占比
                }]
            },
            options: {
                responsive: true,
                indexAxis: 'y',  // 反转图表，横纵轴交换
                scales: {
                    x: {
                        beginAtZero: true,  // 横轴从 0 开始
                        title: {
                            display: true,
                            text: '下载量'
                        },
                        ticks: {
                            stepSize: 10,  // 设置刻度间隔为 10
                            callback: function (value) {
                                if (value % 10 === 0) {  // 只显示整10的数字
                                    return value;
                                }
                                return '';  // 其他值不显示
                            }
                        }
                    },
                    y: {
                        display: false  // 隐藏纵轴
                    }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            title: function (tooltipItem) {
                                // 显示完整的文件名作为提示框标题
                                const index = tooltipItem[0].dataIndex;
                                return labels[index];  // 返回完整的文件名
                            },
                            label: function (tooltipItem) {
                                return `下载量: ${tooltipItem.raw}`;  // 显示下载量作为提示框内容
                            }
                        }
                    },
                    datalabels: {
                        anchor: 'end',  // 将标签固定在柱子中间
                        align: 'right',   // 标签居中显示
                        color: 'black',    // 设置标签文字颜色
                        font: {
                            size: 10          // 设置字体大小
                        },
                        formatter: function (value, context) {
                            return context.chart.data.labels[context.dataIndex];  // 显示文件名
                        }
                    }
                }
            },
            plugins: [ChartDataLabels]  // 注册插件
        });
    }

    function renderUploadedFiles(uploads) {
        if (!uploads || uploads.length == 0) return;
        uploadedFileList.innerHTML = '';

        uploads.forEach(file => {
            const row = document.createElement('tr');
            const size = (file.size / (1024 * 1024)).toFixed(2);
            let strExpired = "";
            let operationBtn = `<button class="btn btn-primary btn-sm" onclick="downloadFile('${file.hash}')">下载</button>`;

            let lockedStatus = "";
            if (file.locked) {
                lockedStatus = `<i style="color:red" class="fas fa-lock"></i>`;
            }
            let color = "white";
            if (file.uploaded_by < 0) {
                uploadedBy = "匿名"
            }
            else {
                uploadedBy = file.uploaded_by
            }
            if (file.expired_at) {
                if (!file.expired_at.Valid) {
                    strExpired = "永久有效";
                    color = "green";
                }
                else {
                    const expiredAt = new Date(`${file.expired_at.Time}`);
                    const now = new Date();
                    // 计算时间差，单位为毫秒
                    const diffInMs = expiredAt - now;
                    if (diffInMs > 0) {
                        // 将毫秒转换为小时和分钟
                        const diffInMinutes = Math.floor(diffInMs / 60000); // 转换为分钟
                        const hours = Math.floor(diffInMinutes / 60); // 小时
                        const minutes = diffInMinutes % 60; // 分钟
                        strExpired = `${hours}小时${minutes}分后`
                        color = "red";
                    }
                    else {
                        const diffInMinutes = Math.floor(0 - diffInMs / 60000); // 转换为分钟
                        const hours = Math.floor(diffInMinutes / 60); // 小时
                        const minutes = diffInMinutes % 60; // 分钟
                        strExpired = `已过期${hours}小时${minutes}分`
                        color = "gray";
                        operationBtn = '';
                    }
                }
            }

            row.innerHTML = `
                <td>
                    <a href="javascript:void(0);" onclick="previewFile('${file.hash}')">
                        <span class="file-name">${file.filename} ${lockedStatus}</span>
                    </a>
                </td>
                <td><small>${size} MB</small></td>
                <td><small>${uploadedBy}</small></td>
                <td>
                    <span style="color:${color}" class="expired-time">${strExpired}</span>
                </td>
                <td>${operationBtn}</td>
            `;
            uploadedFileList.appendChild(row);
        });
    }

    async function removeUploadedFile(element) {
        const listItem = element.parentNode;
        const fileName = listItem.firstChild.textContent.split(' - ')[0];
        await fetch(`/remove/${fileName}`, { method: 'DELETE' });
        listItem.remove();
    }

    // 更新上传成功的文件表格
    function renderSuccessFiles(data) {
        const successTable = document.getElementById('success-table');
        successTable.classList.remove('hidden');

        const successTableBody = document.getElementById('success-table').getElementsByTagName('tbody')[0];
        successTableBody.innerHTML = ''; // 清空现有的表格

        data.forEach(file => {
            const label = file.label.substring(file.label.lastIndexOf("_") + 1); // 获取文件标识
            const fullPath = `${backend_yingwu}/files/download/${label}`;

            const row = document.createElement('tr');
            row.innerHTML = `
            <td>${file.fileName}</td>
            <td>
                <span id="file-id-${label}" class="text-bg-success"
                    style="cursor: pointer; background-color: white; color: green; font-weight: bold; padding: 3px 8px;"
                    onclick="copyText('${label}')">
                    ${label}
                </span>

            </td>
            <td>
                <span id="file-id-${label}" class="text-bg-success"
                    style="cursor: pointer; background-color: white; color: blue; font-weight: bold; padding: 3px 8px;"
                    onclick="copyText('${fullPath}')">
                    ${fullPath}
                </span>
            </td>
        `;
            successTableBody.appendChild(row);
        });
    }

    // 更新上传失败的文件表格
    function renderFailureFiles(data) {
        const failureTable = document.getElementById('failure-table');
        failureTable.classList.remove('hidden');  // 显示失败表格
        const failureTableBody = document.getElementById('failure-table').getElementsByTagName('tbody')[0];
        failureTableBody.innerHTML = ''; // 清空现有的表格

        data.forEach(file => {
            const row = document.createElement('tr');
            row.innerHTML = `
            <td>${file.id}</td>
            <td>${file.reason}</td>
        `;
            failureTableBody.appendChild(row);
        });
    }

    // 复制单个文件标识
    function copyText(text) {
        navigator.clipboard.writeText(text).then(() => {
            showToast(`已复制`);
        }).catch(err => {
            console.error('复制失败', err);
        });
    }

    // 渲染上传记录
    const renderUploadedHistory = (files) => {
        const uploadTableBody = document.getElementById('uploadTableLocal').getElementsByTagName('tbody')[0];
        uploadTableBody.innerHTML = ''; // 清空现有记录
        files.forEach(function (file) {
            const fileName = file.fileName ? file.fileName : "";
            const label = file.label ? file.label.substring(file.label.lastIndexOf("_") + 1) : ""; // 获取文件标识
            const fullPath = label ? `${backend_yingwu}/files/download/${label}` : "";
            const uploadedAt = file.uploadedAt ? formatDateFull(file.uploadedAt) : "";
            $('#uploadTableLocal tbody').append(`
            <tr>
                <td>${fileName}</td>
                <td><span class="label-style">${label}</span></td>
                <td>${uploadedAt}</td>
            </tr>`);
        });
    }

    // 渲染下载记录
    const renderDownloadedHistory = (files) => {
        const downloadTableBody = document.getElementById('downloadTableLocal').getElementsByTagName('tbody')[0];
        downloadTableBody.innerHTML = ''; // 清空现有记录
        files.forEach(function (file) {
            const fileName = file.fileName ? file.fileName : "";
            const label = file.label ? file.label.substring(file.label.lastIndexOf("_") + 1) : ""; // 获取文件标识
            // const fullPath = label ? `${backend_yingwu}/files/download/${label}` : "";
            const downloadedAt = file.downloadedAt ? formatDateFull(file.downloadedAt) : "";
            $('#downloadTableLocal tbody').append(`
            <tr>
                <td>${fileName}</td>
                <td><span class="label-style">${label}</span></td>
                <td>${downloadedAt}</td>
            </tr>`);
        });
    }


    const confirmClearCacheModal = new bootstrap.Modal(document.getElementById('confirmClearCacheModal'), {
        backdrop: 'static',  // 禁止点击外部区域关闭模态框
        keyboard: false      // 禁止按下 ESC 键关闭模态框
    });

    const confirmDeleteFileModal = new bootstrap.Modal(document.getElementById('confirmDeleteFileModal'), {
        backdrop: 'static',  // 禁止点击外部区域关闭模态框
        keyboard: false      // 禁止按下 ESC 键关闭模态框
    });
    $('#confirmDeleteFileModal').on('hidden.bs.modal', function () {
        this.dataset.hashes = '';
    });

    function openConfirmClearCacheModal() {
        confirmClearCacheModal.show();
        renderCacheDetails();
    }

    function openConfirmDeleteFileModal(files) {
        confirmDeleteFileModal.show();
        renderDeleteFiles(files);
    }

    const clearCache = async () => {
        const cache = await caches.open('file-cache');
        const cacheKeys = await cache.keys();
        for (const request of cacheKeys) {
            await cache.delete(request);
        }
        showToast("缓存已清理");
        confirmClearCacheModal.hide();
    };

    async function getCacheDetails() {
        try {
            const cacheNames = await caches.keys(); // 获取所有缓存名称
            let totalSize = 0; // 记录总大小
            const cacheDetails = []; // 存储每个缓存的详细信息

            for (const cacheName of cacheNames) {
                const cache = await caches.open(cacheName); // 打开缓存
                const requests = await cache.keys(); // 获取所有请求
                let cacheSize = 0; // 单个缓存大小

                for (const request of requests) {
                    const response = await cache.match(request); // 匹配缓存
                    if (response) {
                        const blob = await response.blob(); // 转为 Blob 对象
                        cacheSize += blob.size; // 累计缓存大小
                    }
                }

                // 累计总大小
                totalSize += cacheSize;

                // 添加当前缓存信息到结果数组
                cacheDetails.push({
                    cacheName,
                    itemCount: requests.length,
                    sizeMB: (cacheSize / (1024 * 1024)).toFixed(2),
                });
            }

            return {
                totalSizeMB: (totalSize / (1024 * 1024)).toFixed(2),
                caches: cacheDetails,
            };
        } catch (error) {
            console.error("获取缓存信息时出错:", error);
            return { error: "无法获取缓存信息" };
        }
    }

    async function renderCacheDetails() {
        let isNightMode = false;
        const user_attr = JSON.parse(localStorage.getItem('USER_ATTR'));
        if (user_attr && user_attr.custom_style === CustomStyle.NightMode) isNightMode = true;

        const cacheInfo = await getCacheDetails(); // 获取缓存数据
        const listContainer = document.getElementById("cache-list"); // 获取容器

        // 清空列表
        listContainer.innerHTML = "";

        if (cacheInfo.error) {
            listContainer.innerHTML = `<div class="text-danger">${cacheInfo.error}</div>`;
            return;
        }

        // 渲染缓存总大小
        const totalSize = document.getElementById("total-cache-size");
        totalSize.textContent = `总缓存: ${cacheInfo.totalSizeMB} MB`;

        // 渲染每个缓存项目
        cacheInfo.caches.forEach(cache => {
            const listItem = `
            <li class="list-group-item d-flex justify-content-between align-items-center
            ${isNightMode ? "night-mode" : ""}">
                <span>${cache.cacheName}</span>
                <span>
                    <span class="badge bg-primary rounded-pill">${cache.itemCount} 项</span>
                    <span class="badge bg-secondary rounded-pill">${cache.sizeMB} MB</span>
                </span>
            </li>
        `;
            listContainer.insertAdjacentHTML("beforeend", listItem);
        });
    }

    function renderDeleteFiles(files) {
        const deleteFileList = document.getElementById("delete-file-list");
        deleteFileList.innerHTML = '';  // 清空之前的内容
        const hashes = [];

        // 遍历文件数组，生成表格行
        files.forEach((file, index) => {
            const row = document.createElement('tr');  // 创建表格行 <tr>

            // 创建序号列
            const serialNumberCell = document.createElement('td');
            serialNumberCell.textContent = index + 1;  // 序号从 1 开始
            row.appendChild(serialNumberCell);  // 将序号列添加到行中

            // 创建文件名列
            const filenameCell = document.createElement('td');
            filenameCell.textContent = file.filename;
            filenameCell.style.fontWeight = "bold";
            row.appendChild(filenameCell);

            // 将该行添加到表格中
            deleteFileList.appendChild(row);

            // 将文件的hash存储到数组中
            hashes.push(file.hash);
        });

        // 将hashes数组存储到模态框的dataset中
        const modal = document.getElementById("confirmDeleteFileModal");
        modal.dataset.hashes = JSON.stringify(hashes);
    }


    function requestUploadedHistory() {
        const status = localStorage.getItem("blog_website_login");
        if (status === "true") {
            loadUploadPage(1);
        }
        let uploaded_files = sessionStorage.getItem("uploaded_files");
        if (uploaded_files) {
            uploaded_files = JSON.parse(uploaded_files);
            const { successFiles } = uploaded_files;
            renderUploadedHistory(successFiles);
        }
    }

    $(document).ready(function () {
        changePage(currentUploadedPage);
        requestDownloadedFilesRank();
        $('#uploadedModal').on('hidden.bs.modal', function () {
            // 模态框关闭时，隐藏成功和失败表格
            const successTable = document.getElementById('success-table');
            const failureTable = document.getElementById('failure-table');

            successTable.classList.add('hidden');  // 隐藏成功表格
            failureTable.classList.add('hidden');  // 隐藏失败表格
        });

        // 保证点击关闭按钮时模态框关闭
        $('#uploadedModal .btn-close').on('click', function () {
            uploadedModal.hide();
        });

        // 点击上传记录按钮，显示上传记录
        $('#btnUploadRecord').click(function () {
            requestUploadedHistory();
            const uploadedFilesModal = new bootstrap.Modal(document.getElementById('uploadFilesHistoryModal'));
            uploadedFilesModal.show();
        });

        $('#uploadFilesHistoryModal').on('hidden.bs.modal', function () {
            // 取消全选和所有选中
            const selectAllCheckbox = document.getElementById('selectAllUploadedHistory');
            selectAllCheckbox.checked = false;  // 取消全选框选中状态
            const fileCheckboxes = document.querySelectorAll('.file-select');
            fileCheckboxes.forEach(checkbox => {
                checkbox.checked = false;  // 取消所有文件的选中状态
            });
        });

        // 点击下载记录按钮，显示下载记录
        $('#btnDownloadRecord').click(function () {
            const status = localStorage.getItem("blog_website_login");
            if (status === "true") {
                loadDownloadPage(1);
            }
            let downloaded_files = sessionStorage.getItem("downloaded_files");
            if (downloaded_files) {
                downloaded_files = JSON.parse(downloaded_files);
                renderDownloadedHistory(downloaded_files);
            }
            const downloadedFilesModal = new bootstrap.Modal(document.getElementById('downloadedFilesHistoryModal'));
            downloadedFilesModal.show();
        });
        document.getElementById('btnToggleNightMode').onclick = toggleNightMode;

        $("#btnOpenConfirmClearModal").click(openConfirmClearCacheModal);
        $("#btnConfirmClearCache").click(clearCache);
        $("#btnCancelClearCache").click(() => confirmClearCacheModal.hide());
        $("#btnCancelDeleteFile").click(() => confirmDeleteFileModal.hide());
        $("#btnConfirmDeleteFile").click(onConfirmDeleteFileBtnClicked);

    });

</script>
<!-- 旧版本2.10.377 -->
<script src="./js/pdf.min.js"></script>
<script src="./js/pdf.worker.min.js"></script>
<!-- 新版本4.8.69 -->
<!-- <script type="module">// 预览文件
    import * as pdfjsLib from './js/pdf.mjs';
    pdfjsLib.GlobalWorkerOptions.workerSrc = './js/pdf.worker.mjs';
    window.pdfjsLib = pdfjsLib;
</script> -->
<script>
    let pdfDoc = null;  // PDF 文档对象
    let currentPage = 1; // 当前页数
    let totalPages = 0;  // 总页数
    let previewFileID = null;// 当前预览文件id
    const canvas = document.getElementById('pdf-canvas');
    const ctx = canvas.getContext('2d');
    let zoomLevel = 1.0; // 初始缩放比例
    let initScale = 2; // 初始canvas缩放比例

    let isRendering = false;        // 用于标记是否正在渲染
    let isDragging = false;         // 是否在拖拽pdf
    let startX, startY;             // pdf起始位置
    let offsetX = 0, offsetY = 0;   // PDF 页面偏移量
    // 定义偏移量的最大和最小值
    const minX = -1500;  // 最小 X 偏移量（例如：页面左边界）
    const maxX = 1500;   // 最大 X 偏移量（例如：页面右边界）
    const minY = -1500;  // 最小 Y 偏移量（例如：页面上边界）
    const maxY = 1500;   // 最大 Y 偏移量（例如：页面下边界）
    let dragFactor = 1;  // 初始拖动幅度倍数/拖拽灵敏度

    // 高分屏适配
    if (window.innerWidth > 768) {
        initScale = 8;
        dragFactor = 4;
    }

    const zoomInButton = document.getElementById('zoom-in');
    const zoomOutButton = document.getElementById('zoom-out');
    const resetZoomButton = document.getElementById('reset-zoom');

    // 放大功能
    zoomInButton.addEventListener('click', function () {
        if (zoomLevel < 2.0) {
            zoomLevel += 0.25;
            zoomLevel = parseFloat(zoomLevel.toFixed(2));
            updateCanvasZoom();
        }
    });

    // 缩小功能
    zoomOutButton.addEventListener('click', function () {
        if (zoomLevel > 0.25) { // 防止缩小到不可见
            zoomLevel -= 0.25; // 每次缩小
            zoomLevel = parseFloat(zoomLevel.toFixed(2));
            updateCanvasZoom();
        }
    });
    // 还原缩放
    resetZoomButton.addEventListener('click', function () {
        zoomLevel = 1.0;
        initPdfOffset();
        updateCanvasZoom();
        scrollToLeftTop();
    });

    // 更新 canvas 缩放
    function updateCanvasZoom() {
        canvas.style.transform = `scale(${zoomLevel})`; // 使用 transform 缩放
        canvas.style.transformOrigin = 'center top'; // 设置缩放的起始点为中间
        renderPdf(currentPage);
        document.getElementById('current-zoom-scale').textContent = zoomLevel;
    }

    function setPreviewPdfPageNum(fileID, pageNum) {
        const k = ItemKey.Preview_File_Info;
        let v = localStorage.getItem(k);
        v = v ? JSON.parse(v) : {};
        v[fileID] = {
            extType: "pdf",
            pageNum,
        }
        localStorage.setItem(k, JSON.stringify(v));
    }

    function getPreviewPdfPageNum(fileID) {
        const k = ItemKey.Preview_File_Info;
        const v = localStorage.getItem(k);
        const i = v ? JSON.parse(v)[fileID] : null;
        const r = i ? i["pageNum"] : null;
        return r;
    }

    async function renderPdfOutline() {
        // 获取大纲（目录）
        const outline = await pdfDoc.getOutline();

        // 显示大纲，递归展示子目录
        const outlineContainer = document.getElementById('outline-list');

        // 从 item.dest 中解析页码
        async function getPageNumberFromItem(item) {
            if (!item.dest) {
                throw new Error("Item does not contain a valid destination.");
            }

            // 处理字符串目标
            if (typeof item.dest === "string") {
                const destination = await pdfDoc.getDestination(item.dest);
                const pageRef = destination[0]; // 第一个元素是页面引用
                const pageNumber = await pdfDoc.getPageIndex(pageRef);
                return pageNumber + 1; // 页码从 1 开始
            }

            // 处理数组目标
            if (Array.isArray(item.dest)) {
                const pageRef = item.dest[0]; // 第一个元素通常是页面引用
                const pageNumber = await pdfDoc.getPageIndex(pageRef);
                return pageNumber + 1; // 页码从 1 开始
            }

            throw new Error("Unsupported item.dest format.");
        }

        const renderOutline = async (outlineItems, parentElement) => {
            for (const item of outlineItems) {
                const itemElement = document.createElement('div');
                itemElement.classList.add('outline-item');
                // 创建目录标题
                const titleElement = document.createElement('span');
                titleElement.textContent = item.title || '无标题';
                titleElement.classList.add('outline-title');
                // 创建页码元素
                const pageNumberElement = document.createElement('span');
                pageNumberElement.classList.add('outline-page-number');
                pageNumberElement.textContent = '...'; // 默认显示加载状态
                // 设置点击事件，跳转到对应页面
                itemElement.onclick = async () => {
                    // 从目标中获取页码
                    const pageNumber = await getPageNumberFromItem(item);
                    renderPdf(pageNumber);
                };
                // 异步加载页码
                try {
                    const pageNumber = await getPageNumberFromItem(item);
                    pageNumberElement.textContent = pageNumber;
                } catch (error) {
                    console.error("Failed to load page number:", error);
                    pageNumberElement.textContent = "N/A";
                }
                // 组合元素
                itemElement.appendChild(titleElement);
                itemElement.appendChild(pageNumberElement);
                parentElement.appendChild(itemElement);

                // 如果存在子目录项，递归处理
                if (item.items && item.items.length > 0) {
                    const nestedContainer = document.createElement('div');
                    nestedContainer.classList.add('nested');
                    renderOutline(item.items, nestedContainer); // 递归处理子目录
                    parentElement.appendChild(nestedContainer);
                }
            };
        };

        // 渲染大纲
        if (outline) {
            renderOutline(outline, outlineContainer);
        } else {
            outlineContainer.textContent = '该 PDF 没有目录';
        }

    }

    // 目录宽度调节器
    const outlineContainer = document.getElementById('outline-container');
    const resizer = document.getElementById('resizer');
    let isResizing = false;
    const onMouseMove = (e) => {
        if (!isResizing) return;

        // 计算新的宽度，限制范围
        const newWidth = Math.max(200, Math.min(window.innerWidth * 0.8, e.clientX));
        outlineContainer.style.width = `${newWidth}px`;
    };

    const onMouseUp = () => {
        if (isResizing) {
            isResizing = false;
            document.body.style.cursor = ''; // 恢复鼠标光标
            document.body.style.userSelect = ''; // 恢复文本选择

            // 移除事件监听器
            document.removeEventListener('mousemove', onMouseMove);
            document.removeEventListener('mouseup', onMouseUp);
        }
    };

    resizer.addEventListener('mousedown', (e) => {
        isResizing = true;
        document.body.style.cursor = 'ew-resize'; // 改变鼠标光标
        document.body.style.userSelect = 'none'; // 禁止选中文本

        // 添加事件监听器
        document.addEventListener('mousemove', onMouseMove);
        document.addEventListener('mouseup', onMouseUp);
    });

    // 渲染 PDF 页面
    async function renderPdf(pageNumber) {
        if (isRendering) return;  // 如果正在渲染，跳过当前渲染请求
        try {
            isRendering = true;  // 标记为正在渲染
            // 获取页面对象
            const page = await pdfDoc.getPage(pageNumber);

            // 设置缩放比例
            const scale = initScale * zoomLevel;
            const viewport = page.getViewport({ scale });

            // 设置 canvas 尺寸
            canvas.width = viewport.width;
            canvas.height = viewport.height;
            // 渲染页面到 canvas
            await page.render({
                canvasContext: ctx,
                viewport,
                renderInteractiveForms: true,  // 启用表单交互
                // imageLayer: true               // 启用更高质量的图像渲染
                transform: [1, 0, 0, 1, offsetX, offsetY]  // 应用偏移量
            }).promise;

            // 更新页码显示
            currentPage = pageNumber;
            document.getElementById('page-input').value = currentPage;
            document.getElementById('current-page-top').textContent = currentPage;
            document.getElementById('total-pages-top').textContent = totalPages;
            // 保存到本地
            setPreviewPdfPageNum(previewFileID, pageNumber);
        } catch (error) {
            console.error("渲染页面失败：", error);
        } finally {
            isRendering = false;  // 渲染完成或出错后，重置标志
        }
    }

    // 打开预览（示例，点击按钮时）
    function openPreview(contentType, contentSrc, fileID) {
        previewFileID = fileID;
        const nightModeActive = $('body').hasClass('night-mode');
        if (nightModeActive) {
            $("#preview-content").addClass("night-mode");
            $("#pdf-content").addClass("night-mode");
            $("#outline-container").addClass("night-mode");
            $("#pdf-toolbar-top").addClass("night-mode");
            $("#pdf-toolbar").addClass("night-mode");
        }
        else {
            $("#preview-content").removeClass("night-mode");
            $("#pdf-content").removeClass("night-mode");
            $("#outline-container").removeClass("night-mode");
            $("#pdf-toolbar-top").removeClass("night-mode");
            $("#pdf-toolbar").removeClass("night-mode");
        }

        if (contentType === 'pdf') {
            showPdfPreview(contentSrc);
        }
        else if (["jpg", "jpeg", "png", "gif"].includes(contentType)) {
            showImage(contentSrc);
        }
        else {
            // closePreview();
            // showToast("该文件格式暂不支持预览", 'top-right', 'bg-warning')
            showText(contentSrc);
        }
    }

    // 显示 PDF 预览
    async function showPdfPreview(pdfUrl) {
        $("#pdf-content").css("display", "flex");
        try {
            // 加载 PDF
            // if (window.pdfjsLib) {
            pdfDoc = await pdfjsLib.getDocument({
                url: pdfUrl,
                cMapUrl: './bcmaps/', // CMap 文件所在目录
                cMapPacked: true,          // 如果使用打包的 .bcmap 文件，设置为 true
            }).promise;

            // 渲染目录
            renderPdfOutline();

            totalPages = pdfDoc.numPages;
            const pageNum = getPreviewPdfPageNum(previewFileID);
            renderPdf(pageNum ? pageNum : 1);
            // }
        } catch (error) {
            closePreview();
            console.error("加载PDF失败：", error);
            showToast("加载PDF失败", 'top-right', 'bg-warning')
        }
    }

    // 坐标置零
    function initPdfOffset() {
        startX = 0; startY = 0;
        offsetX = 0; offsetY = 0;
    }

    // 重置滚动条位置
    const pdfCanvasContainer = document.getElementById('pdf-canvas-container');
    function scrollToLeftTop() {
        pdfCanvasContainer.scrollTop = 0;  // 重置垂直滚动条
        pdfCanvasContainer.scrollLeft = 0; // 重置水平滚动条
    }

    // 翻到上一页
    function goToPrevPage() {
        if (currentPage > 1) {
            currentPage--;
            initPdfOffset();
            renderPdf(currentPage);
            scrollToLeftTop();
        }
    }

    // 翻到下一页
    function goToNextPage() {
        if (currentPage < totalPages) {
            currentPage++;
            initPdfOffset();
            renderPdf(currentPage);
            scrollToLeftTop();
        }
    }

    // 获取按钮和输入框元素
    const goToPageButton = document.getElementById('go-to-page');
    const pageInput = document.getElementById('page-input');
    // 跳转到指定页
    goToPageButton.addEventListener('click', () => {
        const inputPage = parseInt(document.getElementById('page-input').value, 10);
        if (inputPage >= 1 && inputPage <= totalPages) {
            currentPage = inputPage;
            initPdfOffset();
            renderPdf(currentPage);
            scrollToLeftTop();
        } else {
            showToast("请输入有效的页码范围！");
        }
    });
    // 监听输入框的键盘事件
    pageInput.addEventListener('keydown', function (event) {
        if (event.key === 'Enter') {  // 检查是否按下的是 Enter 键
            event.preventDefault();
            goToPageButton.click();
        }
    });
    // 全屏显示功能
    const pdfContainer = document.getElementById('pdf-content');
    const fullscreenButton = document.getElementById('fullscreen-pdf');
    // 全屏切换函数

    function enterFullScreen() {
        if (!document.fullscreenElement) {
            // 进入全屏
            if (pdfContainer.requestFullscreen) {
                pdfContainer.requestFullscreen();
            } else if (pdfContainer.webkitRequestFullscreen) { // Safari
                pdfContainer.webkitRequestFullscreen();
            } else if (pdfContainer.msRequestFullscreen) { // IE/Edge
                pdfContainer.msRequestFullscreen();
            }
            // $("#pdf-toolbar").css("margin-top", "0px");
        }
    }
    function toggleFullScreen() {
        if (!document.fullscreenElement) {
            enterFullScreen();
        }
        else {
            exitFullscreen();
        }
    }
    function exitFullscreen() {
        if (document.fullscreenElement) {
            if (document.exitFullscreen) {
                document.exitFullscreen();
            } else if (document.webkitExitFullscreen) { // Safari
                document.webkitExitFullscreen();
            } else if (document.msExitFullscreen) { // IE/Edge
                document.msExitFullscreen();
            }
            // $("#pdf-toolbar").css("margin-top", "40px");
        }
    }
    // 全屏按钮点击事件
    fullscreenButton.addEventListener('click', toggleFullScreen);
    // 添加全屏事件监听器，切换按钮文本和背景颜色
    // 监听全屏状态变化
    document.addEventListener('fullscreenchange', () => {
        if (document.fullscreenElement === pdfContainer) {
            // 进入全屏
            pdfContainer.style.backgroundColor = 'white';
            fullscreenButton.innerHTML = '<i class="bi bi-arrows-collapse"></i>';  // 使用退出全屏图标
            fullscreenButton.classList.remove('btn-info');
            fullscreenButton.classList.add('btn-secondary');
        } else {
            // 退出全屏
            pdfContainer.style.backgroundColor = '';
            fullscreenButton.innerHTML = '<i class="bi bi-arrows-fullscreen"></i>';  // 使用全屏图标
            fullscreenButton.classList.remove('btn-secondary');
            fullscreenButton.classList.add('btn-info');
        }
    });

    // Safari 兼容性
    document.addEventListener('webkitfullscreenchange', () => {
        if (document.webkitFullscreenElement === pdfContainer) {
            pdfContainer.style.backgroundColor = 'white';
            fullscreenButton.innerHTML = '<i class="bi bi-arrows-collapse"></i>';  // 使用退出全屏图标
            fullscreenButton.classList.remove('btn-info');
            fullscreenButton.classList.add('btn-secondary');
        } else {
            pdfContainer.style.backgroundColor = '';
            fullscreenButton.innerHTML = '<i class="bi bi-arrows-fullscreen"></i>';  // 使用全屏图标
            fullscreenButton.classList.remove('btn-secondary');
            fullscreenButton.classList.add('btn-info');
        }
    });

    function closePreview() {
        $("#preview-container").css("display", "none");
        document.getElementById("image-preview").src = "";
        $("#image-content").css("display", "none");
        $("#pdf-content").css("display", "none");
        $("#text-content").css("display", "none");
        document.getElementById("text-preview").innerText = '';
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        exitFullscreen();
        previewFileID = null;
        const outlineContainer = document.getElementById('outline-list');
        outlineContainer.innerHTML = ""; // 清空目录
        initPdfOffset();
    }

    // 绑定翻页按钮事件
    document.getElementById('prevPage_preview').addEventListener('click', goToPrevPage);
    document.getElementById('nextPage_preview').addEventListener('click', goToNextPage);


    document.getElementById("btnTogglePdfNote").addEventListener("click", function () {
        this.classList.toggle('expand');
        const noteContainer = $("#note-iframe");
        if (this.classList.contains("expand")) {
            // noteContainer.css("display", "flex");
            noteContainer.toggleClass("d-none d-block");
        } else {
            // noteContainer.css("display", "none");
            noteContainer.toggleClass("d-block d-none");
        }
    });

    document.getElementById("btnTogglePdfOutline").addEventListener("click", function () {
        this.classList.toggle('expand');
        const pdfContainer = $("#outline-container");
        if (this.classList.contains("expand")) {
            pdfContainer.css("display", "flex");
        } else {
            pdfContainer.css("display", "none");
        }
    });

    // 开始拖动
    function startDrag(e) {
        isDragging = true;
        const point = getEventPoint(e);
        startX = point.x;
        startY = point.y;
        canvas.style.cursor = 'grabbing';
        e.preventDefault();
    }

    // 拖动中
    function drag(e) {
        if (!isDragging) return;

        const point = getEventPoint(e);
        const dx = (point.x - startX) * dragFactor;
        const dy = (point.y - startY) * dragFactor;

        offsetX += dx;
        offsetY += dy;

        // 限制偏移量在合理范围内
        offsetX = Math.max(minX, Math.min(maxX, offsetX));
        offsetY = Math.max(minY, Math.min(maxY, offsetY));

        // 重渲染 PDF 页面时应用当前的偏移量
        renderPdf(currentPage);

        // 更新起始点
        startX = point.x;
        startY = point.y;

        e.preventDefault();
    }

    // 停止拖动
    function stopDrag(e) {
        isDragging = false;
        canvas.style.cursor = 'grab';
        e.preventDefault();
    }

    // 获取事件的触点坐标（支持鼠标和触摸）
    function getEventPoint(e) {
        if (e.touches && e.touches[0]) {
            return { x: e.touches[0].clientX, y: e.touches[0].clientY };
        }
        return { x: e.clientX, y: e.clientY };
    }

    // 添加事件监听
    canvas.addEventListener('mousedown', startDrag);
    canvas.addEventListener('mousemove', drag);
    canvas.addEventListener('mouseup', stopDrag);
    canvas.addEventListener('mouseleave', stopDrag); // 防止鼠标移出画布时未结束拖动

    // 移动端触摸事件监听
    canvas.addEventListener('touchstart', startDrag);
    canvas.addEventListener('touchmove', drag);
    canvas.addEventListener('touchend', stopDrag);


    // 关闭pdf预览
    document.getElementById('closePreview-pdf').addEventListener('click', closePreview);

    // 图片预览
    function showImage(imageUrl) {
        $("#image-content").css("display", "flex");
        document.getElementById("image-preview").src = imageUrl;
    }
    // 关闭图片预览
    document.getElementById('closePreview-img').addEventListener('click', closePreview);

    // 文本预览
    function showText(blobUrl) {
        $("#text-content").css("display", "flex");

        const reader = new FileReader();
        reader.onload = function (event) {
            const textContent = event.target.result;
            document.getElementById('text-preview').innerText = textContent;
        };
        fetch(blobUrl)
            .then(response => response.blob())  // 获取 Blob 数据
            .then(blob => reader.readAsText(blob)) // 使用 FileReader 读取文本内容
            .catch(error => console.error('Error reading blob:', error));
    }
    document.getElementById('closePreview-text').addEventListener('click', closePreview);
</script>

<!--注册回调、鉴权  -->
<script>
    function handleLoginResult(result) {
        if (result && result.userID) {
            document.getElementById('auth-btn_homepage').style.display = 'none';
            document.getElementById('userAvatarButton').style.display = 'inline-block';
            document.getElementById('user-id').textContent = result.userID;
        }
        else {
            document.getElementById('auth-btn_homepage').style.display = 'block';
            document.getElementById('userAvatarButton').style.display = 'none';
            document.getElementById('user-id').textContent = "";
        }
    }

    function onLogoutClicked() {
        logout();
        document.getElementById('auth-btn_homepage').style.display = 'block';
        document.getElementById('userAvatarButton').style.display = 'none';
    }

    document.addEventListener('DOMContentLoaded', async () => {
        document.getElementById("btn_login_github").onclick = () => openAuthPopup();
        document.getElementById('auth-btn_homepage').onclick = (event) => {
            const cookieConsent = getCookie('cookieConsent');
            if (cookieConsent !== 'true') {
                event.preventDefault();
                // 调用震动效果函数
                shakeCookieBanner();
                return;
            }
            var loginModal = new bootstrap.Modal(document.getElementById('loginModal'));
            loginModal.show();
        }

        const result = await authorize();
        handleLoginResult(result);
    });

    function initTheme() {
        const user_attr = JSON.parse(localStorage.getItem('USER_ATTR'));
        if (user_attr && user_attr.custom_style === CustomStyle.NightMode) {
            toggleNightMode();
        }
    }
    window.onload = initTheme();
</script>

</html>