<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="../img/yingwu.ico" type="image/x-icon" />
    <title>鹦鹉网盘</title>
    <link rel="stylesheet" href="../css/common.css">
    <link rel="stylesheet" href="../css/bootstrap.min.css">
    <link href="../css/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="../css/all.min.css">
    <style>
        .navbar {
            margin: 0;
        }

        .navbar-brand {
            font-size: 16px;
            font-weight: bold;
            margin-left: 0;
            color: #007bff;
            transition: color 0.3s;
        }

        .navbar-brand:hover {
            color: #0056b3;
            text-decoration: underline;
        }

        .container {
            margin-top: 60px;
            max-width: 98%;
        }

        #dropZone {
            border: 2px dashed #007bff;
            border-radius: 5px;
            padding: 40px 10px;
            text-align: center;
            margin-bottom: 10px;
            position: relative;
            transition: background-color 0.3s;
            background-color: #e9f7ff;
        }

        #dropZone.dragover {
            background-color: #b3e0ff;
        }

        #uploadButton {
            font-size: 30px;
            background: transparent;
            border: none;
            color: #007bff;
            cursor: text;
        }

        .file-list {
            max-height: 500px;
            overflow-y: auto;
            margin-bottom: 10px;
            background-color: #ffffff;
            border-radius: 5px;
            padding: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .file-list ul {
            padding-left: 0;
        }

        .file-list li {
            list-style-type: none;
            border-bottom: 1px solid #f1f1f1;
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background-color 0.2s;
        }

        .file-list li:hover {
            background-color: #f1f1f1;
        }

        .remove-file {
            cursor: pointer;
            color: red;
            margin-left: 10px;
            font-weight: bold;
        }

        .row {
            display: flex;
            justify-content: space-between;
        }

        .col {
            flex: 1;
            margin: 0 10px;
        }

        .upload-area {
            background-color: #f3f5f6;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            border: 1px solid white;
        }

        .download-area {
            background-color: #f4f4f4;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            border: 1px solid white;
        }

        /* 上传加载框 */
        #waitingModal {
            display: none;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background-color: rgba(0, 0, 0, 0.5);
        }

        #loading-content {
            background-color: transparent;
            border: none;
            margin-top: 40vh;
        }

        .loading-spinner {
            color: white;
        }

        /* 预览容器 */
        .preview-container {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            justify-content: center;
            align-items: center;
            z-index: 20;
            /* 确保容器位于蒙版之上 */
            background: rgba(0, 0, 0, 0.6);
            /* 半透明背景蒙版 */
        }

        /* 内容容器居中 */
        .preview-content {
            width: 90%;
            max-width: 1000px;
            max-height: 90%;
            background-color: #fff;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            /* 添加阴影 */
            border-radius: 8px;
            padding: 20px;
            box-sizing: border-box;
            overflow: auto;
            display: flex;
            flex-direction: column;
        }

        /* 内嵌的图片和 PDF 内容容器 */
        .preview-content img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        /* PDF 内容居中 */
        .preview-content canvas {
            display: block;
            max-width: 100%;
            max-height: 100%;
            margin: 0 auto;
        }

        #pdf-content {
            display: none;
            flex-direction: column;
        }

        #image-content {
            display: none;
            flex-direction: column;
        }

        .image-preview {
            max-height: 40vh;
            width: auto;
        }

        .hidden {
            display: none;
        }

        .modal-dialog {
            max-width: 80%;
            margin-left: 10%;
        }

        .modal-content {
            word-break: break-all;
        }

        /* 表格样式 */
        .table td,
        .table th {
            vertical-align: middle;
        }

        /* 无文本加载弹窗 */
        #loadingModal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            text-align: center;
            line-height: 100vh;
            font-size: 1.5rem;
            z-index: 9999;
            user-select: none;
        }

        .waiting-spinner {
            margin-bottom: 20px;
        }
    </style>
</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">主页</a>
            <div class="ml-auto d-flex">
                <!-- 按钮 -->
                <button id="btnUploadRecord" class="btn btn-outline-light btn-sm mx-1 no-focus" data-toggle="tooltip"
                    title="上传记录" data-placement="bottom">
                    <i class="bi bi-upload"></i>
                </button>

                <button id="btnDownloadRecord" class="btn btn-outline-light btn-sm mx-1 no-focus" data-toggle="tooltip"
                    title="下载记录" data-placement="bottom">
                    <i class="bi bi-download"></i>
                </button>
                <button id="auth-btn_homepage" class="btn btn-outline-light btn-sm mx-1 no-focus" data-toggle="tooltip"
                    title="登录" data-placement="bottom" data-bs-toggle="modal" data-bs-target="#loginModal">
                    <i class="fas fa-sign-in-alt"></i>
                </button>
                <button id="btn_logout" class="btn btn-outline-light btn-sm mx-1 no-focus" data-toggle="tooltip"
                    title="注销" data-placement="bottom" style="display: none;">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </div>
    </nav>

    <div class="container">
        <!-- 文件上传区域 -->
        <div id="dropZone" class="text-center">
            <button id="uploadButton">
                <i class="fas fa-arrow-up"></i>
            </button>
            <div style="margin-bottom: 10px;">将文件拖拽到这里上传</div>
            <input type="file" id="fileInput" class="form-control-file mb-2" multiple style="display: none;" />
            <label for="fileInput" class="btn btn-primary">选择文件上传</label>
        </div>

        <div class="row g-3">
            <!-- 上传文件列表 -->
            <div class="col-md-8 upload-area">
                <table class="table">
                    <thead>
                        <tr>
                            <th>文件名</th>
                            <th>大小</th>
                            <th>进度</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="uploadFileList">
                        <!-- 动态添加上传文件信息 -->
                    </tbody>
                </table>
                <div class="text-right">
                    <button id="uploadFileButton" class="btn btn-success btn-sm">上传文件</button>
                </div>
                <h6 class="mt-2">已上传文件</h6>
                <div class="file-list">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>文件名</th>
                                <th>大小</th>
                                <th>过期时间</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="uploadedFileList"></tbody>
                    </table>
                </div>
                <!-- 分页控件 -->
                <ul class="pagination" id="uploaded_files_pagination">
                    <li class="page-item" id="prevPage">
                        <a class="page-link" href="javascript:void(0);" onclick="changePage(currentUploadedPage - 1)"
                            aria-label="Previous">
                            <span aria-hidden="true">&laquo;</span>
                        </a>
                    </li>
                    <li class="page-item disabled" id="pageInfo">
                        <span class="page-link">第 1 页 / 共 10 页</span>
                    </li>
                    <li class="page-item" id="nextPage">
                        <a class="page-link" href="javascript:void(0);" onclick="changePage(currentUploadedPage + 1)"
                            aria-label="Next">
                            <span aria-hidden="true">&raquo;</span>
                        </a>
                    </li>
                </ul>
            </div>


            <!-- 下载文件区域 -->
            <div class="col-md-4 download-area">
                <h6 class="mt-2">下载文件</h6>
                <div class="input-group mb-3">
                    <input type="text" id="fileId" class="form-control form-control-sm" placeholder="输入文件标识" required
                        data-bs-toggle="tooltip" data-bs-placement="bottom" title="请输入文件标识">
                    <div class="input-group-append">
                        <button id="downloadButton" class="btn btn-success btn-sm ms-2">下载</button>
                    </div>
                </div>

                <h6 class="mt-2">文件下载排名</h6>
                <div class="file-list">
                    <canvas id="downloadChart" width="400" height="200"></canvas>
                </div>

            </div>
        </div>

        <div id="waitingModal" class="modal" tabindex="-1" role="dialog">
            <div class="modal-dialog" role="document">
                <div id="loading-content" class="modal-content text-center">
                    <div class="modal-body">
                        <div class="loading-spinner">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">正在加载...</span>
                            </div>
                            <div>正在上传文件...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
    <!-- 预览容器（背景蒙版与内容容器组合） -->
    <div class="preview-container" id="preview-container">
        <div class="preview-content" id="preview-content">
            <div id="pdf-content">
                <div class="d-flex justify-content-center">
                    <div class="d-flex flex-row align-items-center border p-3 rounded">
                        <button id="prevPage" class="btn btn-sm btn-primary mb-2 mx-2">
                            <i class="bi bi-arrow-left-circle"></i>
                        </button>
                        <button id="nextPage" class="btn btn-sm btn-primary mb-2 mx-2">
                            <i class="bi bi-arrow-right-circle"></i>
                        </button>
                        <button id="closePreview-pdf" class="btn btn-sm btn-danger mb-2 mx-2">
                            <i class="bi bi-x-circle"></i>
                        </button>
                    </div>
                </div>
                <canvas id="pdf-canvas"></canvas>
            </div>
            <!-- 图片显示区域 -->
            <div id="image-content">
                <div class="d-flex justify-content-end">
                    <div class="d-flex flex-row align-items-center border p-3 rounded">
                        <button id="closePreview-img" class="btn btn-sm btn-danger mb-2 mx-2">
                            <i class="bi bi-x-circle"></i>
                        </button>
                    </div>
                </div>
                <img id="image-preview" class="img-fluid" alt="img-preview" style="max-height: 100%; width: auto;">
            </div>
        </div>
    </div>

    <!-- 上传结果模态框 -->
    <div class="modal fade" id="uploadedModal" tabindex="-1" aria-labelledby="uploadedModalLabel">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- 上传成功表格 -->
                    <h5 style="color:red">注意：文件有效期默认为8小时，请及时下载，过期文件无法恢复</h5>
                    <table id="success-table" class="table table-bordered mb-4 table-responsive hidden">
                        <thead>
                            <tr>
                                <th>文件名</th>
                                <th>文件标识</th>
                                <th>文件全路径</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- 文件上传成功信息将插入到这里 -->
                        </tbody>
                    </table>

                    <!-- 上传失败表格 -->
                    <table id="failure-table" class="table table-bordered hidden">
                        <thead>
                            <tr>
                                <th>文件名</th>
                                <th>失败原因</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- 文件上传失败信息将插入到这里 -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- 上传记录的模态框 -->
    <div class="modal fade" id="uploadFilesHistoryModal" tabindex="-1" role="dialog" aria-labelledby="uploadModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="uploadModalLabel">上传记录</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <table class="table table-bordered" id="uploadTable">
                        <thead>
                            <tr>
                                <th>文件名</th>
                                <th>文件标识</th>
                                <th>文件链接</th>
                                <th>上传时间</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- 上传记录列表 -->
                        </tbody>
                    </table>
                    <!-- 分页控件 -->
                    <nav aria-label="Page navigation">
                        <ul class="pagination justify-content-center" id="uploadPagination">
                            <!-- 分页按钮将动态添加到这里 -->
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>

    <!-- 下载记录的模态框 -->
    <div class="modal fade" id="downloadedFilesHistoryModal" tabindex="-1" role="dialog"
        aria-labelledby="downloadModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="downloadModalLabel">下载记录</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <table class="table table-bordered" id="downloadTable">
                        <thead>
                            <tr>
                                <th>文件名</th>
                                <th>文件标识</th>
                                <th>文件链接</th>
                                <th>下载时间</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- 下载记录列表 -->
                        </tbody>
                    </table>
                    <!-- 分页控件 -->
                    <nav aria-label="Page navigation">
                        <ul class="pagination justify-content-center" id="downloadPagination">
                            <!-- 分页按钮将动态添加到这里 -->
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>

    <!-- 登录弹窗 -->
    <div class="modal fade" id="loginModal" tabindex="-1" aria-labelledby="loginModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="loginModalLabel">登录</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- 登录选项按钮 -->
                    <div class="d-flex flex-column">
                        <!-- Github 登录按钮 -->
                        <button class="btn btn-dark mb-2" id="btn_login_github">
                            <i class="fab fa-github"></i> 使用 Github 登录
                        </button>

                        <!-- Google 登录按钮 -->
                        <button class="btn btn-danger mb-2 disabled">
                            <i class="fab fa-google"></i> 使用 Google 登录（暂不支持）
                        </button>

                        <!-- 微信登录按钮 -->
                        <button class="btn btn-success mb-2 disabled">
                            <i class="fab fa-weixin"></i> 使用微信登录（暂不支持）
                        </button>

                        <!-- 手机号登录按钮 -->
                        <button class="btn btn-info mb-2 disabled">
                            <i class="fas fa-phone"></i> 使用手机号登录（暂不支持）
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 加载弹窗的HTML -->
    <div id="loadingModal">
        <div class="waiting-spinner">
            <div class="spinner-border" role="status">
                <span class="sr-only"></span>
            </div>
        </div>
    </div>


</body>
<script src="../js/jquery.min.js"></script>
<script src="../js/constDefine.js"></script>
<script src="../js/common.js"></script>
<script src="../js/util.js"></script>
<script src="../js/bootstrap.bundle.min.js"></script>
<script src="./js/pdf.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0/dist/chartjs-plugin-datalabels.min.js">
</script>
<script>
    // 每页显示条数
    const recordsPerPage = 5;

    // 更新上传记录分页
    function updateUploadPagination(totalRecords) {
        const totalPages = Math.ceil(totalRecords / recordsPerPage);
        const pagination = document.getElementById('uploadPagination');
        pagination.innerHTML = ''; // 清空现有分页内容

        for (let i = 1; i <= totalPages; i++) {
            const li = document.createElement('li');
            li.classList.add('page-item');
            li.innerHTML = `<a class="page-link" href="#" onclick="loadUploadPage(${i})">${i}</a>`;
            pagination.appendChild(li);
        }
    }

    // 更新下载记录分页
    function updateDownloadPagination(totalRecords) {
        const totalPages = Math.ceil(totalRecords / recordsPerPage);
        const pagination = document.getElementById('downloadPagination');
        pagination.innerHTML = ''; // 清空现有分页内容

        for (let i = 1; i <= totalPages; i++) {
            const li = document.createElement('li');
            li.classList.add('page-item');
            li.innerHTML = `<a class="page-link" href="#" onclick="loadDownloadPage(${i})">${i}</a>`;
            pagination.appendChild(li);
        }
    }

    // 加载上传记录页面数据
    async function loadUploadPage(pageNum) {
        try {
            const response = await fetch(`${backend_yingwu}/files/uploads?page=${pageNum}&limit=${recordsPerPage}`, {
                credentials: 'include'
            });
            if (response.ok) {
                const data = await response.json();
                renderUploadRecords(data.files);
                updateUploadPagination(data.totalCount);
            } else {
                alert('无法加载上传记录');
            }
        } catch (error) {
            console.error(error);
        }
    }

    // 加载下载记录页面数据
    async function loadDownloadPage(pageNum) {
        try {
            const response = await fetch(`/api/download/records?page=${pageNum}&limit=${recordsPerPage}`, {
                credentials: 'include'
            });

            if (response.ok) {
                const data = await response.json();
                renderDownloadRecords(data.files);
                updateDownloadPagination(data.totalCount);
            } else {
                alert('无法加载下载记录');
            }
        } catch (error) {
            console.error(error);
        }
    }

    // 渲染上传记录到表格
    function renderUploadRecords(records) {
        const uploadTableBody = document.getElementById('uploadTable').getElementsByTagName('tbody')[0];
        uploadTableBody.innerHTML = ''; // 清空现有记录

        records.forEach(record => {
            const row = document.createElement('tr');
            row.innerHTML = `
            <td>${record.filename}</td>
            <td>${formatFileSize(record.size)}</td>
            <td>${record.uploaded_at}</td>
        `;
            uploadTableBody.appendChild(row);
        });
    }

    // 渲染下载记录到表格
    function renderDownloadRecords(records) {
        const downloadTableBody = document.getElementById('downloadTable').getElementsByTagName('tbody')[0];
        downloadTableBody.innerHTML = ''; // 清空现有记录

        records.forEach(record => {
            const row = document.createElement('tr');
            row.innerHTML = `
            <td>${record.filename}</td>
            <td>${record.downloaded_at}</td>
        `;
            downloadTableBody.appendChild(row);
        });
    }

    // 格式化文件大小（例如：1 MB, 200 KB）
    function formatFileSize(bytes) {
        const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
        if (bytes === 0) return '0 Byte';
        const i = parseInt(Math.floor(Math.log(bytes) / Math.log(1024)));
        return Math.round(bytes / Math.pow(1024, i)) + ' ' + sizes[i];
    }
</script>
<script>
    // 分页参数
    let currentUploadedPage = 1;  // 当前页
    const UploadedFilesPerPage = 10;  // 每页显示的文件数

    // 更新分页信息
    function updateUploadedFilesPagination(totalCount, page) {
        const totalPages = Math.ceil(totalCount / UploadedFilesPerPage);

        // 更新页码信息
        document.getElementById('pageInfo').innerHTML = `第 ${page} 页 / 共 ${totalPages} 页`;

        // 控制上一页、下一页按钮的禁用状态
        document.getElementById('prevPage').classList.toggle('disabled', page <= 1);
        document.getElementById('nextPage').classList.toggle('disabled', page >= totalPages);
    }

    // 切换分页
    function changePage(page) {
        if (page < 1) return;
        fetch(`${backend_yingwu}/files?page=${page}&limit=${UploadedFilesPerPage}`,
            {
                method: 'GET',
                credentials: 'include'
            }
        )
            .then(response => response.json())
            .then(data => {
                renderUploadedFiles(data.files);
                updateUploadedFilesPagination(data.totalCount, page);
                currentUploadedPage = page;
            })
            .catch(error => console.error('Error loading files:', error));
    }

    const requestDownloadedFilesRank = () => {
        fetch(`${backend_yingwu}/files/downloadRank`,
            {
                method: 'GET',
                credentials: 'include'
            }
        )
            .then(response => response.json())
            .then(data => {
                renderDownloadedFilesRank(data.files);
            })
            .catch(error => console.error('Error loading downloaded files rank:', error));
    }

    // 上传文件结果弹窗
    const modalElement = document.getElementById('uploadedModal');
    const uploadedModal = new bootstrap.Modal(modalElement, {
        backdrop: 'static',  // 禁止点击外部区域关闭模态框
        keyboard: false      // 禁止按下 ESC 键关闭模态框
    });
    // 初始化工具提示
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    const tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });

    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');
    const uploadFileList = document.getElementById('uploadFileList');
    const uploadedFileList = document.getElementById('uploadedFileList');
    const downloadFileList = document.getElementById('downloadFileList');
    const maxFileSize = 100 * 1024 * 1024; // 100MB
    let selectedFiles = [];

    dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.classList.add('dragover');
    });

    dropZone.addEventListener('dragleave', () => {
        dropZone.classList.remove('dragover');
    });

    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('dragover');
        handleFiles(e.dataTransfer.files);
    });

    fileInput.addEventListener('change', (e) => {
        handleFiles(e.target.files);
    });

    function handleFiles(files) {
        for (let i = 0; i < files.length; i++) {
            if (files[i].size > maxFileSize) {
                alert(`${files[i].name} 超过最大上传限制 (100MB)`);
                continue;
            }
            // 检查文件名是否重复
            const isDuplicate = selectedFiles.some(file => file.name === files[i].name);
            if (isDuplicate) {
                continue;
            }
            selectedFiles.push(files[i]);

            const row = document.createElement('tr');

            const fileNameCell = document.createElement('td');
            fileNameCell.textContent = files[i].name;
            fileNameCell.style.color = 'gray';  // 设置文本颜色为灰色

            const fileSizeCell = document.createElement('td');
            fileSizeCell.textContent = `${(files[i].size / (1024 * 1024)).toFixed(2)} MB`;

            const progressCell = document.createElement('td');
            const progressBar = document.createElement('div');
            progressBar.className = 'progress';
            const progress = document.createElement('div');
            progress.className = 'progress-bar progress-bar-striped progress-bar-animated';
            progress.style.width = '0%'; // 初始进度
            progress.setAttribute('role', 'progressbar');
            progress.setAttribute('aria-valuenow', '0');
            progress.setAttribute('aria-valuemin', '0');
            progress.setAttribute('aria-valuemax', '100');
            progressBar.appendChild(progress);
            progressCell.appendChild(progressBar);

            const actionCell = document.createElement('td');
            const cancelButton = document.createElement('button');
            cancelButton.className = 'btn btn-danger btn-sm';
            cancelButton.textContent = '取消';
            cancelButton.onclick = () => removeFile(row, progress, cancelButton); // 调用取消函数
            actionCell.appendChild(cancelButton);

            row.appendChild(fileNameCell);
            row.appendChild(fileSizeCell);
            row.appendChild(progressCell);
            row.appendChild(actionCell);
            uploadFileList.appendChild(row);
        }
    }

    /**
     * 合并成功和失败的文件数据，并更新 sessionStorage 中的 uploaded_files
     * @param {Array} successFiles 新上传的成功文件数组
     * @param {Array} failureFiles 新上传的失败文件数组
     */
    function mergeUploadedFilesHistory(successFiles, failureFiles) {
        // 从 sessionStorage 中获取已上传的文件数据
        const uploadedFiles = JSON.parse(sessionStorage.getItem('uploaded_files') || '{}');

        // 提取现有的 successFiles 和 failureFiles，确保它们是数组类型
        const storedSuccessFiles = Array.isArray(uploadedFiles.successFiles) ? uploadedFiles.successFiles : [];
        const storedFailureFiles = Array.isArray(uploadedFiles.failureFiles) ? uploadedFiles.failureFiles : [];

        // 确保传入的 successFiles 和 failureFiles 是数组类型
        const newSuccessFiles = Array.isArray(successFiles) ? successFiles : [];
        const newFailureFiles = Array.isArray(failureFiles) ? failureFiles : [];

        // 合并新的成功文件和失败文件
        const mergedSuccessFiles = [...storedSuccessFiles, ...newSuccessFiles];
        const mergedFailureFiles = [...storedFailureFiles, ...newFailureFiles];

        // 更新 uploadedFiles 对象
        uploadedFiles.successFiles = mergedSuccessFiles;
        uploadedFiles.failureFiles = mergedFailureFiles;

        // 将合并后的数据保存回 sessionStorage
        sessionStorage.setItem('uploaded_files', JSON.stringify(uploadedFiles));
    }

    function mergeDownloadedFilesHistory(files) {
        // 从 sessionStorage 中获取已下载的文件数据
        const storedFiles = JSON.parse(sessionStorage.getItem('downloaded_files') || '[]');

        // 确保传入的 files 是数组类型
        const newFiles = Array.isArray(files) ? files : [];

        // 合并新的文件和存储的文件
        const mergedFiles = [...storedFiles, ...newFiles];

        // 将合并后的数据保存回 sessionStorage
        sessionStorage.setItem('downloaded_files', JSON.stringify(mergedFiles));
    }


    const downloadFile = async (fileID) => {
        try {
            const downloadResponse = await fetch(`${backend_yingwu}/files/download/${fileID}`, {
                credentials: 'include'
            });

            // 检查响应状态
            if (downloadResponse.ok) {
                const contentType = downloadResponse.headers.get('Content-Type');
                if (contentType && contentType.includes('application/json')) {
                    const respJson = await downloadResponse.json();
                    if (respJson) {
                        alert(respJson.error);
                        return;
                    }
                } else {
                    // 处理文件响应
                    let fileName = '未命名文件';
                    const contentDisposition = downloadResponse.headers.get('Content-Disposition');
                    if (contentDisposition) {
                        const filenameMatch = contentDisposition.match(/filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/);
                        if (filenameMatch && filenameMatch[1]) {
                            // 去除引号
                            fileName = filenameMatch[1].replace(/['"]/g, '');
                            // 去除 UTF-8
                            fileName = fileName.replace(/UTF-8/g, '').trim(); // 去除所有的 UTF-8 并去掉多余空格
                            // 解码文件名
                            fileName = decodeURIComponent(fileName);
                        }
                    }
                    const blob = await downloadResponse.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;
                    a.download = fileName; // 指定下载文件名
                    document.body.appendChild(a);
                    a.click(); // 仅下载文件
                    document.body.removeChild(a); // 清理
                    window.URL.revokeObjectURL(url); // 释放 URL 对象

                    // 记录在案
                    const downloadedFile = {
                        fileName,
                        label: "file_" + fileID.substring(0, 6),
                        downloadedAt: new Date().toISOString()
                    }
                    const arr = []
                    mergeDownloadedFilesHistory([...arr, downloadedFile]);
                }
            }
            else {
                showToast("下载失败", 'top-right', 'bg-warning');
            }
        } catch (error) {
            console.error();
        }
    }

    const previewFile = async (fileID) => {
        try {
            const downloadResponse = await fetch(`${backend_yingwu}/files/download/${fileID}`, {
                credentials: 'include'
            });

            // 检查响应状态
            if (downloadResponse.ok) {
                const contentType = downloadResponse.headers.get('Content-Type');
                if (contentType && contentType.includes('application/json')) {
                    const respJson = await downloadResponse.json();
                    if (respJson) {
                        alert(respJson.error);
                        return;
                    }
                } else {
                    // 处理文件响应
                    let fileName = '未命名文件';
                    const contentDisposition = downloadResponse.headers.get('Content-Disposition');
                    if (contentDisposition) {
                        const filenameMatch = contentDisposition.match(/filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/);
                        if (filenameMatch && filenameMatch[1]) {
                            // 去除引号
                            fileName = filenameMatch[1].replace(/['"]/g, '');
                            // 去除 UTF-8
                            fileName = fileName.replace(/UTF-8/g, '').trim(); // 去除所有的 UTF-8 并去掉多余空格
                            // 解码文件名
                            fileName = decodeURIComponent(fileName);
                        }
                    }
                    // 获取 Blob 数据
                    const blob = await downloadResponse.blob();

                    // 创建 Blob URL
                    const blobUrl = URL.createObjectURL(blob);
                    let fileExtension = fileName.substring(fileName.lastIndexOf('.') + 1);
                    document.getElementById('preview-container').style.display = 'flex'; // 显示预览容器
                    openPreview(fileExtension, blobUrl);
                    setTimeout(() => URL.revokeObjectURL(blobUrl), 60000);
                }
            }
            else {
                showToast("文件不存在", 'top-right', 'bg-warning');
            }
        } catch (error) {
            showToast("发送请求失败");
        }
    }

    function removeFile(element) {
        const row = element.closest('tr'); // 获取当前行
        const fileName = row.cells[0].textContent; // 获取第一列（文件名）

        // 从 selectedFiles 中移除对应的文件
        selectedFiles = selectedFiles.filter(file => file.name !== fileName);

        // 获取进度条和取消按钮
        const progressBar = row.querySelector('.progress-bar');
        const cancelButton = row.querySelector('button');

        // 将进度条变灰并停止动画
        progressBar.className = 'progress-bar'; // 移除动画和样式
        progressBar.style.backgroundColor = '#6c757d'; // 设置灰色
        progressBar.style.width = '100%'; // 显示为已取消状态

        // 禁用取消按钮并变灰
        cancelButton.className = 'btn btn-secondary btn-sm'; // 改为次要按钮
        cancelButton.disabled = true; // 禁用按钮
        cancelButton.textContent = '已取消'; // 改变按钮文本
    }

    const uploadFile = async () => {
        if (selectedFiles.length === 0) {
            alert("请拖拽或选择文件上传");
            return;
        }
        const formData = new FormData();
        selectedFiles.forEach(file => formData.append('files', file));
        $('#waitingModal').modal('show');
        try {
            const response = await fetch(`${backend_yingwu}/files/upload`, {
                method: 'POST',
                body: formData,
                credentials: 'include'
            });
            if (response.ok) {
                const data = await response.json();
                if (data.result) {
                    const { successFiles, failureFiles, failureCount, message } = data.result;
                    selectedFiles = [];
                    uploadFileList.innerHTML = '';
                    fileInput.value = '';

                    // 修改文本为上传成功
                    const spinnerText = $('#waitingModal .loading-spinner div:nth-child(2)');
                    spinnerText.text('上传成功！');
                    $('#waitingModal').modal('hide');
                    if (successFiles && successFiles.length > 0) {
                        successFiles.forEach(file => {
                            file.uploadedAt = new Date().toISOString();
                        });
                        renderSuccessFiles(successFiles);
                    }
                    if (failureCount > 0 && failureFiles && failureFiles.length > 0) {
                        failureFiles.forEach(file => {
                            file.uploadedAt = new Date().toISOString();
                        });
                        renderFailureFiles(failureFiles);
                    }
                    uploadedModal.show();
                    // 保存记录到本地
                    mergeUploadedFilesHistory(successFiles, failureFiles);
                }
            }
            else {
                // 修改文本为上传失败
                const spinnerText = $('#waitingModal .loading-spinner div:nth-child(2)');
                spinnerText.text('上传失败！');
                $('#waitingModal').modal('hide');
            }
        } catch (error) {
            console.error(error);
            const spinnerText = $('#waitingModal .loading-spinner div:nth-child(2)');
            spinnerText.text('上传失败！');
            $('#waitingModal').modal('hide');
        }
    }
    document.getElementById('uploadFileButton').onclick = uploadFile;

    const fileIdInput = document.getElementById('fileId');
    const downloadButton = document.getElementById('downloadButton');

    // 监听输入框变化
    fileIdInput.addEventListener('input', function () {
        const tooltip = bootstrap.Tooltip.getInstance(this);
        if (this.value) {
            if (tooltip) {
                tooltip.dispose(); // 移除工具提示
            }
        } else {
            if (!tooltip) {
                new bootstrap.Tooltip(this).show(); // 显示工具提示
            } else {
                tooltip.show(); // 确保工具提示可见
            }
        }
    });

    downloadButton.onclick = async function () {
        const fileId = fileIdInput.value;

        if (!fileId) {
            bootstrap.Tooltip.getInstance(fileIdInput) || new bootstrap.Tooltip(fileIdInput).show(); // 显示工具提示
            return;
        }

        // 如果输入框不为空，继续下载
        downloadFile(fileId);
    };

    function renderDownloadedFilesRank(files) {
        // 提取文件名和下载量，确保下载量为整数
        const labels = files.map(file => file.filename);
        const downloadCounts = files.map(file => Math.floor(file.download_count)); // 保证下载量为整数

        // 设置最大文件名长度为 8，超出部分使用 '...' 表示
        const maxFilenameLength = 50; // 设置文件名的最大字符数
        const truncatedLabels = labels.map(filename => {
            if (filename.length > maxFilenameLength) {
                return filename.substring(0, maxFilenameLength) + '...';
            }
            return filename;
        });

        // 创建柱状图
        const ctx = document.getElementById('downloadChart').getContext('2d');
        const chart = new Chart(ctx, {
            type: 'bar',  // 设置图表类型为柱状图
            data: {
                labels: truncatedLabels,  // 截断后的文件名
                datasets: [{
                    label: '下载量',
                    data: downloadCounts,  // 下载量
                    backgroundColor: 'rgba(54, 162, 235, 0.2)',  // 柱状图的背景色
                    borderColor: 'rgba(54, 162, 235, 1)',  // 柱状图的边框色
                    borderWidth: 1,
                    barThickness: 20,  // 设置柱子的固定宽度
                    categoryPercentage: 0.6,  // 控制每个类别的宽度
                    barPercentage: 0.8,  // 控制柱子在类别宽度中的占比
                }]
            },
            options: {
                responsive: true,
                indexAxis: 'y',  // 反转图表，横纵轴交换
                scales: {
                    x: {
                        beginAtZero: true,  // 横轴从 0 开始
                        title: {
                            display: true,
                            text: '下载量'
                        },
                        ticks: {
                            stepSize: 10,  // 设置刻度间隔为 10
                            callback: function (value) {
                                if (value % 10 === 0) {  // 只显示整10的数字
                                    return value;
                                }
                                return '';  // 其他值不显示
                            }
                        }
                    },
                    y: {
                        display: false  // 隐藏纵轴
                    }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            title: function (tooltipItem) {
                                // 显示完整的文件名作为提示框标题
                                const index = tooltipItem[0].dataIndex;
                                return labels[index];  // 返回完整的文件名
                            },
                            label: function (tooltipItem) {
                                return `下载量: ${tooltipItem.raw}`;  // 显示下载量作为提示框内容
                            }
                        }
                    },
                    datalabels: {
                        anchor: 'end',  // 将标签固定在柱子中间
                        align: 'right',   // 标签居中显示
                        color: 'black',    // 设置标签文字颜色
                        font: {
                            size: 10          // 设置字体大小
                        },
                        formatter: function (value, context) {
                            return context.chart.data.labels[context.dataIndex];  // 显示文件名
                        }
                    }
                }
            },
            plugins: [ChartDataLabels]  // 注册插件
        });
    }

    function renderUploadedFiles(uploads) {
        if (!uploads || uploads.length == 0) return;
        uploadedFileList.innerHTML = '';

        uploads.forEach(file => {
            const row = document.createElement('tr');
            const size = (file.size / (1024 * 1024)).toFixed(2);
            let strExpired = "";
            let color = "white";
            if (file.expired_at) {
                if (!file.expired_at.Valid) {
                    strExpired = "永久有效";
                    color = "green";
                    row.innerHTML = `
                        <td><a href="javascript:void(0);" onclick="previewFile('${file.hash}')">${file.filename}</a></td>
                        <td>${size} MB</td>
                        <td style="color:${color};">${strExpired}</td>
                        <td>
                            <button class="btn btn-success btn-sm" onclick="downloadFile('${file.hash}')">下载</button>
                        </td>
                    `;
                }
                else {
                    const expiredAt = new Date(`${file.expired_at.Time}`);
                    const now = new Date();
                    // 计算时间差，单位为毫秒
                    const diffInMs = expiredAt - now;
                    if (diffInMs > 0) {
                        // 将毫秒转换为小时和分钟
                        const diffInMinutes = Math.floor(diffInMs / 60000); // 转换为分钟
                        const hours = Math.floor(diffInMinutes / 60); // 小时
                        const minutes = diffInMinutes % 60; // 分钟
                        strExpired = `${hours}小时${minutes}分后`
                        color = "red";
                        row.innerHTML = `
                            <td><a href="javascript:void(0);" onclick="previewFile('${file.hash}')">${file.filename}</a></td>
                            <td>${size} MB</td>
                            <td style="color:${color};">${strExpired}</td>
                            <td>
                                <button class="btn btn-success btn-sm" onclick="downloadFile('${file.hash}')">下载</button>
                            </td>
                        `;
                    }
                    else {
                        const diffInMinutes = Math.floor(0 - diffInMs / 60000); // 转换为分钟
                        const hours = Math.floor(diffInMinutes / 60); // 小时
                        const minutes = diffInMinutes % 60; // 分钟
                        strExpired = `已过期${hours}小时${minutes}分`
                        color = "gray";
                        row.innerHTML = `
                            <td><a href="javascript:void(0);" onclick="previewFile('${file.hash}')">${file.filename}</a></td>
                            <td>${size} MB</td>
                            <td style="color:${color};">${strExpired}</td>
                        `;
                    }
                }
            }

            uploadedFileList.appendChild(row);
        });
    }

    async function removeUploadedFile(element) {
        const listItem = element.parentNode;
        const fileName = listItem.firstChild.textContent.split(' - ')[0];
        await fetch(`/remove/${fileName}`, { method: 'DELETE' });
        listItem.remove();
    }

    // 更新上传成功的文件表格
    function renderSuccessFiles(data) {
        const successTable = document.getElementById('success-table');
        successTable.classList.remove('hidden');

        const successTableBody = document.getElementById('success-table').getElementsByTagName('tbody')[0];
        successTableBody.innerHTML = ''; // 清空现有的表格

        data.forEach(file => {
            const label = file.label.substring(file.label.lastIndexOf("_") + 1); // 获取文件标识
            const fullPath = `${backend_yingwu}/files/download/${label}`;

            const row = document.createElement('tr');
            row.innerHTML = `
            <td>${file.fileName}</td>
            <td>
                <span id="file-id-${label}" class="text-bg-success"
                    style="cursor: pointer; background-color: white; color: green; font-weight: bold; padding: 3px 8px;"
                    onclick="copyText('${label}')">
                    ${label}
                </span>

            </td>
            <td>
                <span id="file-id-${label}" class="text-bg-success"
                    style="cursor: pointer; background-color: white; color: blue; font-weight: bold; padding: 3px 8px;"
                    onclick="copyText('${fullPath}')">
                    ${fullPath}
                </span>
            </td>
        `;
            successTableBody.appendChild(row);
        });
    }

    // 更新上传失败的文件表格
    function renderFailureFiles(data) {
        const failureTable = document.getElementById('failure-table');
        failureTable.classList.remove('hidden');  // 显示失败表格
        const failureTableBody = document.getElementById('failure-table').getElementsByTagName('tbody')[0];
        failureTableBody.innerHTML = ''; // 清空现有的表格

        data.forEach(file => {
            const row = document.createElement('tr');
            row.innerHTML = `
            <td>${file.id}</td>
            <td>${file.reason}</td>
        `;
            failureTableBody.appendChild(row);
        });
    }

    // 复制单个文件标识
    function copyText(text) {
        navigator.clipboard.writeText(text).then(() => {
            showToast(`已复制`);
        }).catch(err => {
            console.error('复制失败', err);
        });
    }

    // 渲染上传记录
    const renderUploadedHistory = (files) => {
        const uploadTableBody = document.getElementById('uploadTable').getElementsByTagName('tbody')[0];
        uploadTableBody.innerHTML = ''; // 清空现有记录
        files.forEach(function (file) {
            const fileName = file.fileName ? file.fileName : "";
            const label = file.label ? file.label.substring(file.label.lastIndexOf("_") + 1) : ""; // 获取文件标识
            const fullPath = label ? `${backend_yingwu}/files/download/${label}` : "";
            const uploadedAt = file.uploadedAt ? formatDateFull(file.uploadedAt) : "";
            $('#uploadTable tbody').append(`
        <tr>
            <td>${fileName}</td>
            <td>${label}</td>
            <td>${fullPath}</td>
            <td>${uploadedAt}</td>
        </tr>`);
        });
    }
    // 渲染下载记录
    const renderDownloadedHistory = (files) => {
        const downloadTableBody = document.getElementById('downloadTable').getElementsByTagName('tbody')[0];
        downloadTableBody.innerHTML = ''; // 清空现有记录
        files.forEach(function (file) {
            const fileName = file.fileName ? file.fileName : "";
            const label = file.label ? file.label.substring(file.label.lastIndexOf("_") + 1) : ""; // 获取文件标识
            const fullPath = label ? `${backend_yingwu}/files/download/${label}` : "";
            const downloadedAt = file.downloadedAt ? formatDateFull(file.downloadedAt) : "";
            $('#downloadTable tbody').append(`
        <tr>
            <td>${fileName}</td>
            <td>${label}</td>
            <td>${fullPath}</td>
            <td>${downloadedAt}</td>
        </tr>`);
        });
    }

    $(document).ready(function () {
        changePage(currentUploadedPage);
        requestDownloadedFilesRank();
        $('#uploadedModal').on('hidden.bs.modal', function () {
            // 模态框关闭时，隐藏成功和失败表格
            const successTable = document.getElementById('success-table');
            const failureTable = document.getElementById('failure-table');

            successTable.classList.add('hidden');  // 隐藏成功表格
            failureTable.classList.add('hidden');  // 隐藏失败表格
        });

        // 保证点击关闭按钮时模态框关闭
        $('#uploadedModal .btn-close').on('click', function () {
            uploadedModal.hide();
        });

        // 点击上传记录按钮，显示上传记录
        $('#btnUploadRecord').click(function () {
            const status = localStorage.getItem("blog_website_login");
            if (status === "true") {
                loadUploadPage(1);
            }
            let uploaded_files = sessionStorage.getItem("uploaded_files");
            if (uploaded_files) {
                uploaded_files = JSON.parse(uploaded_files);
                const { successFiles } = uploaded_files;
                renderUploadedHistory(successFiles);
            }
            const uploadedFilesModal = new bootstrap.Modal(document.getElementById('uploadFilesHistoryModal'));
            uploadedFilesModal.show();
        });

        // 点击下载记录按钮，显示下载记录
        $('#btnDownloadRecord').click(function () {
            const status = localStorage.getItem("blog_website_login");
            if (status === "true") {
                loadDownloadPage(1);
            }
            let downloaded_files = sessionStorage.getItem("downloaded_files");
            if (downloaded_files) {
                downloaded_files = JSON.parse(downloaded_files);
                renderDownloadedHistory(downloaded_files);
            }
            const downloadedFilesModal = new bootstrap.Modal(document.getElementById('downloadedFilesHistoryModal'));
            downloadedFilesModal.show();
        });
    });

</script>
<script>// 预览文件
    let pdfDoc = null;  // PDF 文档对象
    let currentPage = 1; // 当前页数
    let totalPages = 0;  // 总页数
    const canvas = document.getElementById('pdf-canvas');
    const ctx = canvas.getContext('2d');

    // 渲染 PDF 页面
    async function renderPdf(pageNumber) {
        try {
            // 获取页面对象
            const page = await pdfDoc.getPage(pageNumber);

            // 设置缩放比例
            const scale = 1.5;
            const viewport = page.getViewport({ scale });

            // 设置 canvas 尺寸
            canvas.width = viewport.width;
            canvas.height = viewport.height;

            // 渲染页面到 canvas
            await page.render({ canvasContext: ctx, viewport }).promise;
        } catch (error) {
            console.error("渲染页面失败：", error);
        }
    }

    // 打开预览（示例，点击按钮时）
    function openPreview(contentType, contentSrc) {
        if (contentType === 'pdf') {
            showPdfPreview(contentSrc);
        }
        else if (["jpg", "jpeg", "png", "gif"].includes(contentType)) {
            showImage(contentSrc);
        }
        else {
            closePreview();
            showToast("该文件格式暂不支持预览", 'top-right', 'bg-warning')
        }
    }

    // 显示 PDF 预览
    async function showPdfPreview(pdfUrl) {
        $("#pdf-content").css("display", "flex");
        try {
            // 加载 PDF
            pdfDoc = await pdfjsLib.getDocument(pdfUrl).promise;
            totalPages = pdfDoc.numPages;
            renderPdf(currentPage); // 渲染第一页
        } catch (error) {
            closePreview();
            console.error("加载PDF失败：", error);
        }
    }

    // 翻到上一页
    function goToPrevPage() {
        if (currentPage > 1) {
            currentPage--;
            renderPdf(currentPage);
        }
    }

    // 翻到下一页
    function goToNextPage() {
        if (currentPage < totalPages) {
            currentPage++;
            renderPdf(currentPage);
        }
    }

    function closePreview() {
        $("#preview-container").css("display", "none");
        document.getElementById("image-preview").src = "";
        $("#image-content").css("display", "none");
        $("#pdf-content").css("display", "none");
        ctx.clearRect(0, 0, canvas.width, canvas.height);
    }

    // 绑定翻页按钮事件
    document.getElementById('prevPage').addEventListener('click', goToPrevPage);
    document.getElementById('nextPage').addEventListener('click', goToNextPage);

    // 关闭pdf预览
    document.getElementById('closePreview-pdf').addEventListener('click', closePreview);

    // 图片预览
    function showImage(imageUrl) {
        $("#image-content").css("display", "flex");
        document.getElementById("image-preview").src = imageUrl;
    }
    // 关闭图片预览
    document.getElementById('closePreview-img').addEventListener('click', closePreview);
</script>

<!--注册回调、鉴权  -->
<script>
    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById("btn_logout").onclick = () => logout();
        document.getElementById("btn_login_github").onclick = () => openAuthPopup();
    });
    authorize();
</script>

</html>