<!DOCTYPE html>

<html>

<head>
	<meta charset="utf-8">
	<title>博客</title>
	<!-- 设置手机和电脑背景图自适应 -->
	<meta name="renderer" content="webkit|ie-comp|ie-stand">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	<meta name="viewport" content="width=device-width,user-scalable=yes, minimum-scale=0.4, initial-scale=1 />
	<meta http-equiv=" Cache-Control" content="no-siteapp" />
	<link rel="icon" type="img/x-icon" href="../img/fav.ico">
	<script src="../js/jquery.min.js"></script>
	<script src="../js/util.js"></script>
	<script src="../js/constDefine.js"></script>
	<!-- bootstrap -->
	<link href="../css/bootstrap.min.css" rel="stylesheet">
	<script src="../js/bootstrap.bundle.min.js"></script>
	<link href="../css/all.min.css" rel="stylesheet">
</head>
<style>
	* {
		padding: 0px;
		margin: 0px;
	}

	.div1 {
		/* background-image: url("../img/moon.jpg"); */
		position: absolute;
		background-size: cover;
		background-repeat: no-repeat;
		background-attachment: fixed;
		/* 可解决背景图太小，div2滑到底部没有背景的问题 */
		width: 100%;
		height: 100%;
	}

	.div2 {
		position: relative;
		width: 100%;
		height: 100%;
		background: rgba(255, 255, 255, 0.3);
	}

	a {
		text-decoration: none;
		margin-left: 10px;
		margin-bottom: 6px;
		font-family: "隶书";
		font-size: 30px;
		font-style: unset;
		font-weight: bold;
		color: rgb(73, 73, 73);
		cursor: pointer;
	}

	a:active {
		color: red;
	}

	p {
		text-decoration: underline;
		margin-bottom: 10px;
		font-family: "隶书";
		font-size: 24px;
		font-style: normal;
		font-weight: bold;
		color: #A7535A;
		/*满江红*/
		/* background-color: #CFCCC9; */
		/* opacity: 0.6; */
	}

	ul {
		list-style-type: none;
		padding: 0;
		margin: 0;
	}

	li {
		color: #0F1423;
		/*钢蓝*/
		list-style-type: inherit;
	}

	li>a {
		text-decoration: none;
		margin-bottom: 10px;
		font-family: Consolas, Menlo, Ubuntu Mono, monospace;
		font-size: 24px;
		font-style: unset;
		font-weight: bold;
		cursor: pointer;
	}

	li>a:visited {
		color: #404030;
		/*淡松烟*/

	}

	/*指已经访问过的链接*/
	li>a:link {
		color: #57C3C2;
		/*美蝶绿*/
	}

	/*未访问的链接*/
	li>a:hover {
		color: #2BAE85;
		/*铜绿*/
	}

	/*鼠标悬停在上面的状态*/
	li>a:active {
		color: #F28E16;
		/*杏黄*/
	}

	/*鼠标点击没有释放的状态颜色*/

	.title {
		display: flex;
		flex-direction: row;
		white-space: nowrap;
		justify-content: space-between;
		/* 使 li 和 span 分开并在两端对齐 */
		align-items: center;
		/* 垂直居中对齐 */
	}

	.time {
		margin-left: auto;
		color: rgb(0, 0, 0);
		font-size: medium;
		/* margin-right:1rem; */
		white-space: nowrap;
		background-color: white;
	}

	/* content */
	.container {
		display: flex;
		flex-direction: row;
		margin-left: 0;
		width: auto;
		overflow-x: hidden;
	}

	/* tags */
	#tags {
		flex: 2;
		min-width: 5rem;
		margin-right: 20px;
		box-sizing: border-box;
		overflow-x: hidden;
		background-color: rgb(197, 196, 196, 0.5);
		height: 50vh;
	}

	/* blogs */
	#blogs {
		flex: 8;
		box-sizing: border-box;
		margin-right: 20px;
		display: flex;
		flex-direction: column;
		background-color: rgba(255, 255, 255, 0.5);
	}

	.login-btn {
		text-decoration: none;
		margin-bottom: 10px;
		font-family: "宋书";
		font-size: 18px;
		font-style: unset;
		font-weight: normal;
		color: rgb(73, 73, 73);
		cursor: pointer;
		margin-left: 1rem;
	}

	/* 禁用所有交互的样式 */
	.disabled {
		pointer-events: none;
		opacity: 0.5;
	}

	#loadingModal {
		display: none;
		position: fixed;
		top: 0;
		left: 0;
		width: 100%;
		height: 100%;
		background: rgba(0, 0, 0, 0.7);
		color: white;
		text-align: center;
		line-height: 100vh;
		font-size: 1.5rem;
		z-index: 9999;
		user-select: none;
	}

	.loading-spinner {
		margin-bottom: 20px;
	}

	#auth-btn {
		text-decoration: none;
		color: #ffffff;
		background-color: #333;
		padding: 8px 4px;
		border-radius: 5px;
		transition: background-color 0.3s;
		font-size: 20px;
	}

	#auth-btn:hover {
		background-color: #555;
	}
</style>

<body>
	<div class="div1">
		<div class="div2">
			<div style="display: flex;flex-direction: row;
		margin:0.1rem 1rem;
		border-bottom: 2px solid rgb(109, 46, 46);
		">
				<a href="/">主页</a>
				<div id='d-write-blog' style="margin-left: auto; margin-right: 20px;
				opacity: 0;pointer-events: none;">
					<a href="../editor.md/examples/write-blog.html" id="blog-link">创建博客</a>
				</div>
				<a id='setting-btn' style="display: none;" href="setting/index.html">博客管理</a>
				<a id="auth-btn" onclick="openAuthPopup()">
					<i class="fab fa-github"></i> 登录
				</a>
			</div>
			<div class="container">
				<ul id="tags">
				</ul>
				<ul id="blogs">
				</ul>
			</div>
		</div>
	</div>
	<!-- 加载弹窗的HTML -->
	<div id="loadingModal">
		<div class="loading-spinner">
			<div class="spinner-border" role="status">
				<span class="sr-only"></span>
			</div>
		</div>
	</div>
	<script type="text/javascript">
		const renderBlogs = (blogs) => {
			if (!blogs) return;
			const blogsDiv = document.getElementById("blogs");
			if (isJSON(blogs)) {
				blogs = JSON.parse(blogs);
			}
			blogsDiv.innerHTML = '';
			blogs.forEach(blog => {
				const titleEle = document.createElement('div');
				titleEle.className = "title";
				const liElement = document.createElement('li');
				const aElement = document.createElement('a');
				const spanEle = document.createElement('span');
				spanEle.className = "time";
				spanEle.textContent = blog.time === '' ? '未知时间' : formateDate(blog.time);
				aElement.id = blog.id;
				aElement.href = "../editor.md/examples/blog.html?id=" + blog.id;
				aElement.textContent = blog.title === '' ? '无标题' : blog.title;
				liElement.appendChild(aElement);
				titleEle.appendChild(liElement);
				titleEle.appendChild(spanEle);
				blogsDiv.appendChild(titleEle);
			});
		}

		const renderAllBtn = () => {
			const tagsDiv = document.getElementById("tags");
			const tagEle = document.createElement('div');
			tagEle.className = "tag";
			const liElement = document.createElement('li');
			const aElement = document.createElement('a');
			aElement.href = "#";
			aElement.innerText = "全部";
			aElement.addEventListener('click', function (event) {
				event.preventDefault();
				$.ajax({
					url: backend_url + "/blogs",
					type: "GET",
					success: function (response) {
						renderBlogs(response);
					},
					error: function (xhr, status, error) {
						console.error("Error sending string:", error);
					}
				});
			});

			liElement.appendChild(aElement);
			tagEle.appendChild(liElement);
			tagsDiv.appendChild(tagEle);
		};

		const renderTags = (tags) => {
			const tagsDiv = document.getElementById("tags");
			if (isJSON(tags)) {
				tags = JSON.parse(tags);
			}
			tagsDiv.innerHTML = '';
			renderAllBtn();
			tags.forEach(tag => {
				const tagEle = document.createElement('div');
				tagEle.className = "tag";
				const liElement = document.createElement('li');
				const aElement = document.createElement('a');
				aElement.href = "#" + tag.name;
				aElement.innerText = tag.name;
				aElement.setAttribute("tag-id", tag.id);
				aElement.addEventListener('click', function (event) {
					event.preventDefault();
					const tagId = this.getAttribute('tag-id');
					$.ajax({
						url: backend_url + "/blogs",
						type: "GET",
						data: {
							tags: [tagId],
						},
						success: function (response) {
							renderBlogs(response);
						},
						error: function (xhr, status, error) {
							console.error("Error sending string:", error);
						}
					});
				});

				liElement.appendChild(aElement);
				tagEle.appendChild(liElement);
				tagsDiv.appendChild(tagEle);
			});
		}

		const updateBlogs = (latestUpdateTime) => {
			var url = backend_url + "/blogs";
			$.ajax({
				url: url,
				type: "GET",
				success: function (response) {
					renderBlogs(response);
					window.localStorage.setItem("latestUpdateTime", latestUpdateTime);
					window.localStorage.setItem("blogs", JSON.stringify(response));
				},
				error: function (xhr, status, error) {
					console.error("Error sending string:", error);
				}
			});
		}

		const updateTags = () => {
			var url = backend_url + "/tags";
			$.ajax({
				url: url,
				type: "GET",
				success: function (response) {
					renderTags(response);
				},
				error: function (xhr, status, error) {
					console.error("Error sending string:", error);
				}
			});
		}

		const getLastedUpdateTime = () => {
			var url = backend_url + "/blogs/get-latest-update-time";
			$.ajax({
				url: url,
				type: "GET",
				success: function (response) {
					const clientLatestUpdateTime = window.localStorage.getItem("latestUpdateTime");
					const blogs = window.localStorage.getItem("blogs");
					if (clientLatestUpdateTime !== response || response === '' ||
						clientLatestUpdateTime === undefined || !blogs) {
						updateBlogs(response);
					}
					else {
						renderBlogs(blogs);
					}
					updateTags();
				},
				error: function (xhr, status, error) {
					console.error("Error sending string:", error);
				}
			});
		}

		getLastedUpdateTime();
	</script>

	<script>
		function openAuthPopup() {
			const state = Math.floor(Math.random() * Math.pow(10, 8));
			localStorage.setItem("state", state);
			const url = `https://github.com/login/oauth/authorize?client_id=Iv23liOH77T5kmvXYkx8&redirect_uri=https://blog.chaosgomoku.fun/blog/index.html&allow_signup=true&scope=user:email&state=${state}`;
			window.location.href = url;
		}
	</script>

	<script>

		function logout() {
			sessionStorage.setItem('blog_website_login', 'false');
			freshPage();
		}

		const freshPage = () => {
			const d_write_blog = document.getElementById("d-write-blog");
			const authBtn = document.getElementById("auth-btn");
			const setting_btn = document.getElementById("setting-btn");
			const status = sessionStorage.getItem('blog_website_login');

			if (status === 'true') { // 登录成功
				d_write_blog.style.opacity = 1;
				d_write_blog.style.pointerEvents = 'auto';
				// auth_btn.style.display = 'none';
				authBtn.innerHTML = '<i class="fas fa-sign-out-alt"></i> 退出登录'; // 更改为退出登录
				authBtn.onclick = logout;
				setting_btn.style.display = 'block';
			}
			else {
				d_write_blog.style.opacity = 0;
				d_write_blog.style.pointerEvents = 'none';
				// auth_btn.style.display = 'block';
				authBtn.innerHTML = '<i class="fab fa-github"></i> 登录';
				authBtn.onclick = openAuthPopup;
				setting_btn.style.display = 'none';
			}
		}

		const authorize = () => {
			freshPage();
			// 获取 URL 参数
			const urlParams = new URLSearchParams(window.location.search);
			const code = urlParams.get('code');
			const state = urlParams.get('state');
			const prevState = localStorage.getItem("state");
			if (state && state !== prevState) {
				console.log("state changed.");
			}
			// 检查参数是否存在
			else if (code && state) {
				const status = sessionStorage.getItem('blog_website_login');
				if (status === 'true') return; // 如果已授权就返回
				// 显示加载弹窗
				document.getElementById('loadingModal').style.display = 'block';
				// 将参数发送给后端
				$.ajax({
					url: backend_url + '/auth',
					type: 'POST',
					xhrFields: {
						withCredentials: true
					},
					data: {
						code
					},
					success: function (data) {
						const res = data ? 'true' : 'false';
						sessionStorage.setItem('blog_website_login', res);
						console.log('授权结果：' + res);
						document.body.classList.add('disabled');
						freshPage();
						document.body.classList.remove('disabled');

						// 隐藏加载弹窗
						document.getElementById('loadingModal').style.display = 'none';
						if (!data) { // 授权失败
							alert("您不在白名单当中，请联系网站管理员");
						}
					},
					error: function (xhr, status, error) {
						// 隐藏加载弹窗
						document.getElementById('loadingModal').style.display = 'none';
						if (xhr.status === 500) {
							console.error("服务器异常：", xhr.responseText);
						} else {
							console.error("Error sending string:", error);
						}
					}
				});

			}
		}
		authorize();
	</script>
</body>

</html>